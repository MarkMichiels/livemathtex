# Milestone v1.5: Parser Architecture

**Completed:** 2026-01-13
**Duration:** ~68 min total execution time
**Plans:** 5 plans across 5 phases
**Commits:** 30

## Milestone Goal

Replace regex-driven processing with structural parsing for robustness and extensibility. Addresses ISS-017, ISS-018, ISS-019, ISS-020, ISS-021, ISS-022.

**Constraints:**
- Keep documents clean - no extra visible markup for users
- Maintain backward compatibility - existing documents process identically
- Idempotency is non-negotiable - processing must remain stable on repeated runs

## Phases

### Phase 8: Markdown Parser Integration
**Goal:** Integrate markdown parser library for AST with exact source spans
**Plans:** 1

**Accomplishments:**
- Hybrid parser: markdown-it-py for document structure + pylatexenc for LaTeX positions
- Created `src/livemathtex/parser/markdown_parser.py` with `MarkdownParser` class
- `extract_math_blocks()` returns `ParsedMathBlock` with document offsets and LaTeX nodes
- 34 tests covering inline/display math, code fence exclusion, position accuracy

**Files Changed:**
- `pyproject.toml` - Added markdown-it-py, mdit-py-plugins, pylatexenc dependencies
- `src/livemathtex/parser/markdown_parser.py` - New hybrid parser module
- `tests/test_markdown_parser.py` - 34 parser tests

### Phase 9: Structural Math Parsing
**Goal:** Parse calculations into internal structure with character-level spans
**Plans:** 1

**Accomplishments:**
- Created `ParsedCalculation` dataclass with spans for all semantic parts
- Operations: `===`, `:=`, `==`, `=>`, `:=_==`, `value`, `ERROR`
- `parse_calculation_line()` and `parse_math_block_calculations()` functions
- All spans are document-relative (not math-block-relative)
- 36 tests for calculation parsing

**Files Changed:**
- `src/livemathtex/parser/calculation_parser.py` - New calculation parser module
- `tests/test_calculation_parser.py` - 36 calculation parser tests

### Phase 10: Clear Refactor
**Goal:** Rewrite `clear_text()` to use span-based operations instead of regex
**Plans:** 1

**Accomplishments:**
- Two-pass approach: remove error markup first, then re-parse for accurate spans
- Span-based edits applied in reverse order to preserve offsets
- Properly handles unit hints (both `[unit]` format and extracted from `\text{}`)
- Fixed ISS-021 (document corruption around multiline error blocks)
- 27 tests for clear functionality

**Files Changed:**
- `src/livemathtex/core.py` - Replaced regex clear_text with span-based implementation
- `tests/test_clear_v2.py` - 27 clear tests including ISS-021 regression

### Phase 11: Token Classification
**Goal:** Centralize "is this a unit, variable, or function?" logic
**Plans:** 1

**Accomplishments:**
- Created `TokenClassifier` with `TokenType` enum and `ImplicitMultInfo` dataclass
- `detect_implicit_multiplication()` identifies when latex2sympy splits multi-letter identifiers
- Improved error messages: `"'PPE' was parsed as implicit multiplication (P*P*E)"`
- Single-letter unit conflict tracking (A=ampere, V=volt, W=watt, etc.)
- Fixed ISS-018, ISS-022 (implicit multiplication diagnostics)
- 46 tests for token classification

**Files Changed:**
- `src/livemathtex/engine/token_classifier.py` - New token classifier module
- `src/livemathtex/engine/evaluator.py` - Integrated classifier for better errors
- `tests/test_token_classifier.py` - 46 token classifier tests

### Phase 12: Unit Warnings
**Goal:** Distinguish calculation errors from formatting warnings
**Plans:** 1

**Accomplishments:**
- Created `UnitConversionWarning` exception for dimension mismatches
- Orange warnings (`\color{orange}`) with SI fallback instead of red errors
- Footer shows separate warning count: "no errors, 1 warning"
- Updated `clear_text()` to handle orange warning markup
- Fixed ISS-017 (unit conversion failures need better diagnostics)

**Files Changed:**
- `src/livemathtex/utils/errors.py` - Added UnitConversionWarning
- `src/livemathtex/engine/evaluator.py` - Warning handling and SI fallback
- `src/livemathtex/render/markdown.py` - Footer warning display
- `src/livemathtex/core.py` - Warning tracking and clear patterns

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Hybrid parser (markdown-it-py + pylatexenc) | Best of both: markdown structure + precise LaTeX positions |
| All spans document-relative | Eliminates offset translation errors |
| Two-pass clear approach | Remove errors first, then re-parse for accurate spans |
| Collect all undefined symbols before error | Enables implicit multiplication pattern detection |
| Dimension mismatches are warnings not errors | Calculation succeeded, only formatting failed |

## Issues Resolved

- **ISS-017:** Unit conversion failures show warnings with SI fallback
- **ISS-018:** Multi-letter identifier errors mention intended symbol
- **ISS-019:** Parser architecture modernized
- **ISS-020:** Structural parsing replaces regex patterns
- **ISS-021:** Document corruption around multiline errors fixed
- **ISS-022:** Implicit multiplication diagnostics improved

## Test Coverage

- **Total tests:** 345 (plus 2 xfailed for known pre-existing bugs)
- **New tests added:** 143 (34 + 36 + 27 + 46)
- **All tests passing**

## Statistics

- **LOC added:** ~4,993
- **LOC removed:** ~69
- **Files changed:** 28

---
*Archived: 2026-01-13*
