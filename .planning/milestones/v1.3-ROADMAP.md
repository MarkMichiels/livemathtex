# Milestone v1.3: Unit Hint Preservation

**Completed:** 2026-01-12
**Duration:** ~34 min total execution time
**Plans:** 3 plans across 3 phases

## Milestone Goal

Fix unit hint preservation (ISS-013) and custom unit evaluation lookup (ISS-009) to ensure processing is idempotent - stable results on repeated runs.

## Phases

### Phase 2: Preserve Inline Unit Hints
**Goal:** Inline `[unit]` syntax survives processing and re-processing (ISS-013)
**Plans:** 1

**Accomplishments:**
- Implemented inline unit hint preservation via automatic HTML comment injection
- `$E == [kJ]$` now produces `$E == 1000\ \text{kJ}$ <!-- [kJ] -->` in output
- Added `TestInlineUnitHintReprocessing` test class with 3 tests
- Updated `MarkdownRenderer` to accept tuple format `(result, inline_unit_hint)`

**Files Changed:**
- `src/livemathtex/core.py` - Track inline unit hint and pass to renderer
- `src/livemathtex/render/markdown.py` - Support tuple format, inject HTML comment
- `tests/test_inline_unit_hints.py` - Added reprocessing tests

### Phase 3: Fix Evaluation Unit Lookup
**Goal:** Standalone `$var ==` evaluations find custom units defined with division (ISS-009)
**Plans:** 1

**Accomplishments:**
- Fixed `_handle_assignment` to propagate units for formula assignments
- Added check in `_handle_unit_definition` to prevent redefining existing Pint units
- Fixed `_parse_unit_expression` to resolve prefixed units via `pint_to_sympy_with_prefix`
- Changed `_apply_conversion` to raise errors instead of silently failing
- Added 5 tests in `TestCustomUnitWithDivision` class

**Files Changed:**
- `src/livemathtex/engine/evaluator.py` - Fixed `_handle_assignment` and `_handle_unit_definition`
- `src/livemathtex/engine/pint_backend.py` - Fixed `_parse_unit_expression`
- `tests/test_pint_backend.py` - Added `TestCustomUnitWithDivision` class

### Phase 4: Re-processing Verification
**Goal:** End-to-end verification of unit hint preservation through process→clear→process cycle
**Plans:** 1

**Accomplishments:**
- Added TestUnitHintCycle class with 4 tests for inline and HTML comment unit hints
- Added TestFileCycle class with 2 tests for file-based process/clear/process cycle
- Extended TestInlineUnitHintReprocessing with 2 additional clear→process tests
- Full test suite passes (190 tests, 8 new)

**Files Changed:**
- `tests/test_process_clear_cycle.py` - Added TestUnitHintCycle and TestFileCycle classes
- `tests/test_inline_unit_hints.py` - Added cycle tests

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Tuple format for results dict | Pass inline unit hint as `(result, inline_unit_hint)` to avoid modifying frozen dataclass |
| Unit propagation via `_compute(rhs, propagate_units=True)` | Formula assignments without explicit unit now compute and store the derived unit |
| Prevent redefining existing Pint units | Added check in `_handle_unit_definition` to avoid conflicts |

## Issues Resolved

- **ISS-013:** Inline unit hints survive processing/re-processing
- **ISS-009:** Custom division units work in standalone evaluations

## Test Coverage

- **Total tests:** 190
- **New tests added:** 13 (3 + 5 + 5 reorg)
- **All tests passing**

---
*Archived: 2026-01-12*
