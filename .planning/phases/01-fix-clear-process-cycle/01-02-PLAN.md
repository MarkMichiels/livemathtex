# Plan 01-02: Add Idempotency Check and Verify Full Cycle

## Objective

Ensure processing is idempotent (F9 twice = same result) and that the clear→process cycle produces the same output as original processing.

## Dependency

Requires 01-01 to be complete (error markup fully cleaned).

## Problem Analysis

### Scenario 4: F9 on output.md second time
- **Expected:** File stable, only timestamp changes
- **Current:** Content changes, additional errors appear

### Scenario 6: F9 after clear
- **Expected:** Same result as original F9 on input.md
- **Current:** Different errors, corrupted content

### Root Cause (after 01-01)
If 01-01 fixes clear_text() properly, most issues should be resolved. This plan verifies and adds any additional safeguards needed.

## Implementation Steps

### Step 1: Verify tests pass after 01-01

Run all cycle tests:
```bash
pytest tests/test_process_clear_cycle.py -v
```

If all pass after 01-01, this plan becomes verification-only.

### Step 2: If needed - Add stability check to process_file()

Only if tests still fail after 01-01:

**File:** `src/livemathtex/core.py`

Add a pre-processing check to detect already-processed content and avoid re-parsing error artifacts:

```python
def process_file(input_path, output_path=None, ...):
    # ... existing code ...

    # If processing in-place (output_path is None or same as input)
    # and content appears already processed, clear it first
    if output_path is None or output_path == input_path:
        if '\\color{red}' in content or '\\ }$' in content:
            content, _ = clear_text(content)
```

### Step 3: Verify full test suite

```bash
pytest tests/ -v --tb=short
```

Ensure no regressions in existing functionality.

### Step 4: Manual verification

Test the actual workflow:
1. F9 on input.md → output.md
2. F9 on output.md → should be stable
3. Shift+F9 on output.md → clear
4. F9 on output.md → should match step 1

## Test Verification

All 8 tests in `test_process_clear_cycle.py` should pass:
- `test_scenario_1_process_input` ✓ (already passing)
- `test_scenario_2_copy_input`
- `test_scenario_3_process_output_first_time` ✓ (already passing)
- `test_scenario_4_process_output_second_time`
- `test_scenario_5_clear_output`
- `test_scenario_6_process_after_clear`
- `test_clear_removes_all_error_markup`
- `test_process_stability_multiple_runs`

## Files Changed

| File | Change |
|------|--------|
| `src/livemathtex/core.py` | (conditional) Add stability check if needed |

## Success Criteria

- [ ] All 8 `test_process_clear_cycle.py` tests pass
- [ ] Full test suite passes (no regressions)
- [ ] Manual workflow verification succeeds

## Estimated Duration

~5 minutes (mostly verification if 01-01 fixes the root cause)
