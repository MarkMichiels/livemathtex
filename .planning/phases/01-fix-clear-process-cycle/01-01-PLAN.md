# Plan 01-01: Fix clear_text() Error Markup Patterns

## Objective

Fix `clear_text()` to remove ALL error markup formats, specifically the multiline error pattern with nested braces that currently leaves `\\ }$` artifacts.

## Problem Analysis

### Current Error Format (in processed file)
```latex
$V := 37824
\\ \color{red}{\text{
    Error: Variable name 'V' conflicts with unit 'volt'. Use a subscript like 'V\_1' or 'V\_var' to disambiguate.}}$
```

### After clear_text() - BROKEN
```latex
$V := 37824
\\ }$
```

### Root Cause
Pattern 3 uses `\{[^}]*\}` which stops at the first `}` (inside `\text{...}`), leaving the outer `}$` behind.

The nested brace structure:
```
\color{red}{\text{...}}
           ^      ^  ^^
           1st }  |  2nd } (outer)
                  |
                  inner } of \text
```

## Implementation Steps

### Step 1: Fix nested brace handling in error patterns

Replace the simple `[^}]*` with a pattern that handles one level of nested braces.

**File:** `src/livemathtex/core.py`

**Current Pattern 3:**
```python
error_pattern = r'\\color\{red\}\{[^}]*\}'
```

**Fix:** Use non-greedy matching with proper brace handling:
```python
# Pattern 3: Remove error markup with nested braces
# Matches \color{red}{...} including nested \text{...}
# Uses a pattern that handles one level of nesting: \{(?:[^{}]|\{[^{}]*\})*\}
error_pattern = r'\\color\{red\}\{(?:[^{}]|\{[^{}]*\})*\}'
```

### Step 2: Add pattern for leftover line continuation

Add a cleanup pattern for orphaned `\\ }$` artifacts.

**Add new pattern after Pattern 5:**
```python
# Pattern 6: Remove orphaned line continuation with closing brace
# Matches: \\ }$ or \\}$ at end of math expression (error artifact)
orphan_pattern = r'\\\\\s*\}\$'
# Replace with just $ to close the math block properly
cleared = re.sub(orphan_pattern, '$', cleared)
```

### Step 3: Add pattern for incomplete multiline errors

Handle the case where error spans multiple lines:
```python
# Pattern 7: Remove multiline error blocks entirely
# Matches: newline + \\ + \color{red}{\text{...}} spanning lines
# Use DOTALL flag for multiline matching
multiline_full = r'\n\\\\\s*\\color\{red\}\{\\text\{[\s\S]*?\}\}'
cleared = re.sub(multiline_full, '', cleared)
```

### Step 4: Fix math block with only error (convert to clean definition)

When a definition has an error, it becomes:
```
$V := 37824
\\ \color{red}{...}$
```

After cleaning, we want:
```
$V := 37824$
```

**Add pattern to fix incomplete math blocks:**
```python
# Pattern 8: Fix definitions that end with newline (error was removed)
# Matches: $expr :=? value\n$ (math block with trailing newline before $)
# Convert to: $expr :=? value$
incomplete_def = r'(\$[^$]+:=?\s*[\d.]+)\s*\n+\$'
cleared = re.sub(incomplete_def, r'\1$', cleared)
```

## Test Verification

Run the specific failing test:
```bash
pytest tests/test_process_clear_cycle.py::test_clear_removes_all_error_markup -v
```

Expected: `\\ }$` should not appear in cleared content.

## Files Changed

| File | Change |
|------|--------|
| `src/livemathtex/core.py` | Update `clear_text()` with improved regex patterns |

## Success Criteria

- [ ] `test_clear_removes_all_error_markup` passes
- [ ] No `\\ }$` artifacts remain after clearing
- [ ] No `\color{red}` remains after clearing
- [ ] No `Error:` text remains after clearing
- [ ] Existing tests still pass

## Estimated Duration

~10 minutes
