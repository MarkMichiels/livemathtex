# Phase 4 Plan: Re-processing Verification

## Objective

End-to-end verification that unit hint preservation works through the complete process→clear→process cycle. Add comprehensive tests for inline unit hints and custom division units through full cycle.

## Execution Context

- **Phase**: 4 of 4 (v1.3 Unit Hint Preservation)
- **Depends on**: Phase 2 (ISS-013 inline hints) and Phase 3 (ISS-009 custom units)
- **Type**: Testing/verification (no production code changes expected)
- **Scope**: Small (~1-2 hours)

## Context

### What Was Fixed in Prior Phases

**Phase 2 (ISS-013):** Inline unit hints `$E == [kJ]$` now automatically generate HTML comments in output: `$E == 1000\ \text{kJ}$ <!-- [kJ] -->`. The hint is tracked in `core.py` and passed to the renderer.

**Phase 3 (ISS-009):** Formula assignments like `$ratio := E_1 / m_1$` now propagate units correctly. Variables store their computed unit for use in standalone evaluations.

### Existing Tests

**test_process_clear_cycle.py** (8 tests):
- Tests basic process→clear→process cycle using error-handling example
- Does NOT test unit hint preservation through cycle
- Some tests marked as "BUG: Currently may fail"

**test_inline_unit_hints.py** (19 tests):
- `TestInlineUnitHintParsing` - Parser extraction
- `TestInlineUnitHintConversion` - Full pipeline conversion
- `TestInlineVsHtmlComment` - Precedence
- `TestEdgeCases` - Edge cases
- `TestClearTextPreservesInlineUnitHints` - Clear preservation
- `TestInlineUnitHintReprocessing` - 3 tests for re-processing (added in Phase 2)

### Test Gap Analysis

The existing `TestInlineUnitHintReprocessing` tests process→process but NOT clear→process cycle. Need to verify:
1. `process_text()` → `clear_text()` → `process_text()` produces same result
2. Custom division units (SEC === MWh/kg) survive the cycle
3. File-based cycle (process_file → clear CLI → process_file) works

## Tasks

### Task 1: Add unit hint cycle tests to test_process_clear_cycle.py

Add tests that use documents with unit hints (not just error-handling example):

```python
class TestUnitHintCycle:
    """Tests for unit hint preservation through process/clear cycle."""

    def test_inline_unit_hint_survives_full_cycle(self):
        """$E == [kJ]$ should produce same result after clear and re-process."""

    def test_html_comment_unit_hint_survives_cycle(self):
        """$E ==$ <!-- [kJ] --> should produce same result after cycle."""

    def test_custom_division_unit_survives_cycle(self):
        """SEC === MWh/kg custom unit should work after clear and re-process."""
```

**Files to modify:**
- `tests/test_process_clear_cycle.py`

**Verification:**
- Run `pytest tests/test_process_clear_cycle.py -v`
- All new tests pass

### Task 2: Add file-based cycle tests

Add tests that use `process_file()` and CLI `clear` command (matching the F9/Shift+F9 workflow):

```python
def test_unit_hint_file_cycle(temp_dir):
    """Unit hints survive file-based process → clear → process cycle."""
    # Create input.md with unit hints
    # process_file() → output.md
    # CLI clear output.md
    # process_file() output.md
    # Assert same unit conversion result
```

**Files to modify:**
- `tests/test_process_clear_cycle.py`

**Verification:**
- Run `pytest tests/test_process_clear_cycle.py::test_unit_hint_file_cycle -v`

### Task 3: Extend TestInlineUnitHintReprocessing with clear cycle

The existing 3 tests in `TestInlineUnitHintReprocessing` test process→process. Add process→clear→process:

```python
def test_clear_then_reprocess_preserves_unit_hint(self):
    """Processing after clear should use preserved unit hint."""
    input_content = '$E := 1000000\\ J$\n$E == [kJ]$'

    processed, _ = process_text(input_content)
    cleared, _ = clear_text(processed)
    reprocessed, _ = process_text(cleared)

    assert '\\text{kJ}' in reprocessed
    assert 'kg' not in reprocessed
```

**Files to modify:**
- `tests/test_inline_unit_hints.py`

**Verification:**
- Run `pytest tests/test_inline_unit_hints.py::TestInlineUnitHintReprocessing -v`

### Task 4: Run full test suite and verify no regressions

**Command:**
```bash
cd /home/mark/Repositories/livemathtex
source venv/bin/activate
pytest --tb=short
```

**Expected:** All 185+ tests pass (182 + new tests)

## Verification

### Unit Tests
- [ ] `pytest tests/test_process_clear_cycle.py -v` - All pass
- [ ] `pytest tests/test_inline_unit_hints.py -v` - All pass
- [ ] `pytest tests/test_pint_backend.py -v` - All pass (regression check)

### Full Suite
- [ ] `pytest --tb=short` - All pass, no regressions

### Manual Verification (Optional)
```bash
cd examples/custom-units
livemathtex process input.md
livemathtex clear output.md
livemathtex process output.md
# Verify output still shows correct units
```

## Success Criteria

1. ✅ At least 3 new cycle tests for inline unit hints
2. ✅ At least 1 new test for custom division units through cycle
3. ✅ File-based cycle test added
4. ✅ Full test suite passes with no regressions
5. ✅ ROADMAP.md Phase 4 marked complete

## Output

- Updated `tests/test_process_clear_cycle.py` with unit hint cycle tests
- Updated `tests/test_inline_unit_hints.py` with clear cycle tests
- All tests passing
- Phase 4 marked complete in ROADMAP.md
