# Phase 29: Cross-References - Plan 01

**Feature:** `{{variable}}` syntax to reference calculated values in prose text (ISS-040)

## Objective

Enable users to reference calculated variables in regular text using `{{variable}}` syntax.
- `{{C_max}}` → displays value with unit (e.g., `550 kg`)
- After `clear`, restores `{{C_max}}` syntax
- Supports expressions: `{{T_2030 / C_max * 100}}` → `93.8`

## Context

- Evaluator stores symbols in `self.symbols` (SymbolTable)
- Variables have `latex_name` (e.g., `C_{max}`) and `si_value`/`si_unit`
- Processing pipeline: lexer → IR → evaluator → renderer
- Cross-references need to be processed AFTER all math blocks are evaluated

## Tasks

### Task 1: Reference Detection & Parsing
**Type:** feat
**Files:** `src/livemathtex/parser/reference_parser.py` (new)

Add module to detect and parse `{{...}}` references:
- Extract reference spans from text (outside math blocks)
- Parse content as LaTeX expression
- Handle escaping: `\{{` to produce literal `{{`

Test cases:
- Simple variable: `{{C_{max}}}`
- Expression: `{{T_2030 / C_max}}`
- Escaped: `\{{not a ref}}`
- No false positives in math blocks

### Task 2: Reference Evaluation & Substitution
**Type:** feat
**Files:** `src/livemathtex/core.py`

Integrate reference evaluation into process_text pipeline:
- After math block evaluation completes
- Look up each reference in evaluator's symbol table
- Evaluate expressions using existing expression_evaluator
- Format result with value + unit
- Insert HTML comment to preserve original: `550 kg<!-- {{C_{max}}} -->`

Test cases:
- Variable lookup succeeds
- Expression evaluation works
- Undefined variable shows error
- HTML comment preserves original

### Task 3: Clear Support for Cross-References
**Type:** feat
**Files:** `src/livemathtex/core.py`

Add cross-reference restoration to clear_text:
- Detect pattern: `value<!-- {{ref}} -->`
- Restore to original `{{ref}}` syntax
- Update clear_text to handle new pattern

Test cases:
- Clear restores `{{C_{max}}}`
- Clear handles expressions
- Round-trip: process → clear → process produces stable output

## Success Criteria

- [ ] All existing tests pass (475+ tests)
- [ ] `{{variable}}` displays evaluated value with unit
- [ ] `{{expression}}` evaluates and displays result
- [ ] `clear` restores original `{{...}}` syntax
- [ ] Process/clear cycle is idempotent
- [ ] No false positives (doesn't affect math blocks or code blocks)

## Implementation Notes

- Reference pattern: `{{` followed by non-`}` chars until `}}`
- Must not match inside math blocks (already handled by working on text outside `$...$`)
- HTML comment format allows round-trip without losing original reference
- Reuse existing expression_evaluator for consistency
