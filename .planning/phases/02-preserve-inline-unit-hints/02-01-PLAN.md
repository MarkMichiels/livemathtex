---
phase: 02-preserve-inline-unit-hints
plan: 01
type: execute
---

<objective>
Fix ISS-013: Inline unit hint syntax `$E == [kJ]$` must survive processing and re-processing.

Purpose: The inline syntax is recommended as cleaner than HTML comments, but currently breaks the re-processing workflow. This fix enables idempotent processing regardless of which unit hint syntax is used.

Output: Processing preserves inline hints (as HTML comments), clear_text() restores them, re-processing produces correct results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

**Prior phase context:**
@.planning/phases/01-fix-clear-process-cycle/01-02-SUMMARY.md

**Key source files:**
@src/livemathtex/core.py (clear_text and process_text)
@src/livemathtex/engine/evaluator.py (evaluation with unit hints)
@tests/test_inline_unit_hints.py (existing tests including TestClearTextPreservesInlineUnitHints)

**Constraining decisions from v1.2:**
- Pre-processing approach: clear already-processed content before parsing
- Use nested brace regex for proper matching

**Issue being addressed:**
- ISS-013: Inline unit hint syntax lost after processing, breaks re-processing
- Example: Input `$E == [kJ]$` → Processed `$E == 1000\ \text{kJ}$` (lost) → Re-process falls to SI base units
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add failing test for re-processing with inline hints</name>
  <files>tests/test_inline_unit_hints.py</files>
  <action>
Add a comprehensive test class `TestInlineUnitHintReprocessing` that verifies:
1. Input with inline hint `$E == [kJ]$` processes correctly first time
2. Processed output can be re-processed with same unit (NOT base units)
3. The full cycle: input → process → process again → same result

The test should currently FAIL (proving ISS-013 exists). Run to confirm failure.

Test structure:
```python
class TestInlineUnitHintReprocessing:
    def test_reprocess_preserves_unit_hint(self):
        """Re-processing output should use same unit, not fall back to SI base."""
        input_content = '$E_total := 1000000\\ J$\n$E_kJ := E_total == [kJ]$'

        # First process
        processed1, _ = process_text(input_content)
        assert '\\text{kJ}' in processed1  # Uses kJ

        # Re-process the output
        processed2, _ = process_text(processed1)
        assert '\\text{kJ}' in processed2  # Still kJ, NOT kg·m²/s²
        assert 'kg' not in processed2  # Should NOT fall back to base units
```
  </action>
  <verify>pytest tests/test_inline_unit_hints.py::TestInlineUnitHintReprocessing -v shows FAILING test (expected - proves the bug)</verify>
  <done>Test exists and fails, confirming ISS-013 bug</done>
</task>

<task type="auto">
  <name>Task 2: Preserve inline unit hint as HTML comment during processing</name>
  <files>src/livemathtex/engine/evaluator.py, src/livemathtex/render/markdown.py</files>
  <action>
When processing an evaluation with inline unit hint `[unit]`, append an HTML comment `<!-- [unit] -->` to the output AFTER the result. This ensures the hint survives in the processed output and is available for re-processing.

The flow:
1. Lexer extracts `[unit]` from `$E == [kJ]$` into `calc.unit_comment`
2. Evaluator uses it for conversion
3. **NEW**: Renderer outputs result + HTML comment: `$E == 1000\ \text{kJ}$ <!-- [kJ] -->`

Find where the unit_comment is consumed and add the HTML comment injection. The comment must be OUTSIDE the math block (after `$`) so it doesn't interfere with LaTeX rendering.

Look in:
- `evaluator.py` - `format_result()` or equivalent where unit hint is applied
- `markdown.py` - `render_calculation()` or equivalent that produces output

Do NOT modify the inline hint extraction logic - it works. Only add the comment preservation.
  </action>
  <verify>pytest tests/test_inline_unit_hints.py -v - the new reprocessing test should now PASS</verify>
  <done>Processing with inline hint adds HTML comment, test passes</done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and clean up</name>
  <files>tests/test_inline_unit_hints.py, tests/test_process_clear_cycle.py</files>
  <action>
Run full test suite to ensure no regressions. The key verification points:

1. All existing inline unit hint tests still pass
2. All process/clear cycle tests still pass (v1.2 stability)
3. New reprocessing test passes
4. HTML comment syntax still works (takes precedence if both present)

If any tests fail, investigate and fix. The HTML comment injection should be additive and not break existing behavior.

Also verify that clear_text() correctly handles the new format:
- Input: `$E == 1000\ \text{kJ}$ <!-- [kJ] -->`
- Should restore to: `$E == [kJ]$` (inline syntax preferred) OR preserve comment
  </action>
  <verify>pytest tests/test_inline_unit_hints.py tests/test_process_clear_cycle.py -v - all tests pass</verify>
  <done>Full test suite passes, no regressions, ISS-013 resolved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_inline_unit_hints.py -v` - all tests pass including reprocessing
- [ ] `pytest tests/test_process_clear_cycle.py -v` - no regressions to v1.2 stability
- [ ] `pytest tests/ -v` - full suite passes
- [ ] Manual verification: process a file with `$E == [kJ]$`, check output has `<!-- [kJ] -->`, re-process and verify still shows kJ not base units
</verification>

<success_criteria>

- All tasks completed
- ISS-013 resolved: inline hints survive processing and re-processing
- No regressions to existing functionality
- HTML comment syntax still takes precedence when both present
- clear_text() handles new format correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-preserve-inline-unit-hints/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Preserve Inline Unit Hints Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 3 (Fix Evaluation Unit Lookup) or Phase 2 Plan 2 if additional work needed.
</output>
