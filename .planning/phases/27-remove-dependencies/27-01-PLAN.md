# Phase 27 Plan 01: Custom Parser as Primary Path

<objective>
Make the custom parser the PRIMARY evaluation path with latex2sympy as fallback for unsupported expressions (functions like \\ln, \\sin, etc.). Add support for mathematical constants (pi, e) and fix parser to handle braced exponents correctly.
</objective>

<execution_context>
@src/livemathtex/engine/evaluator.py - Main evaluator with fallback code
@src/livemathtex/parser/expression_tokenizer.py - Custom tokenizer
@src/livemathtex/parser/expression_parser.py - Custom parser
@src/livemathtex/engine/expression_evaluator.py - Custom evaluator
</execution_context>

<context>
## Background

Phase 26 integrated the custom parser with a fallback:
```python
def _compute_with_pint(self, expression_latex: str) -> 'pint.Quantity':
    # Try custom parser first
    try:
        return self._evaluate_with_custom_parser(expression_latex)
    except (ParseError, CustomEvaluationError) as e:
        logger.debug(f"Custom parser failed, falling back to latex2sympy: {e}")

    # Fallback: Original latex2sympy path
    ...existing ~80 lines of latex2sympy code...
```

All 528 tests pass with the custom parser. The fallback is no longer needed for `==` evaluations.

## Scope Clarification

**WILL REMOVE in this phase:**
- latex2sympy fallback code in `_compute_with_pint()`
- `from latex2sympy2 import latex2sympy` if not used elsewhere

**WILL NOT REMOVE (needs SymPy):**
- `_compute()` method - still uses latex2sympy for `:=` definitions (expressions with variables)
- Lambda functions for `f(x) := ...` definitions
- sympy.physics.units for unit formatting
- SymPy Symbol manipulation

**Future work (separate milestone):**
- Extend custom parser to handle `:=` expressions (variables on RHS)
- Replace SymPy Lambda with custom function representation
- Remove sympy.physics.units dependency

## Strategy

1. Remove fallback code from `_compute_with_pint()`
2. Keep custom parser as the ONLY path for `==` evaluations
3. Let errors propagate (no silent fallback)
4. Verify all tests still pass
</context>

<tasks>
## Task 1: Remove fallback code from _compute_with_pint

**Type:** auto

**Files:**
- `src/livemathtex/engine/evaluator.py`

**Action:**
Remove the entire fallback code block from `_compute_with_pint()`. The method should only call `_evaluate_with_custom_parser()`.

Before:
```python
def _compute_with_pint(self, expression_latex: str) -> 'pint.Quantity':
    # Try custom parser first
    try:
        return self._evaluate_with_custom_parser(expression_latex)
    except (ParseError, CustomEvaluationError) as e:
        logger.debug(f"...")

    # Fallback: Original latex2sympy path (~80 lines)
    modified_latex = self._rewrite_with_internal_ids(expression_latex)
    ...
```

After:
```python
def _compute_with_pint(self, expression_latex: str) -> 'pint.Quantity':
    """
    Parse and compute a LaTeX expression using Pint for unit handling.
    Uses custom tokenizer/parser pipeline (v3.0 Pure Pint Architecture).
    """
    return self._evaluate_with_custom_parser(expression_latex)
```

**Verify:**
- Method is simplified
- No fallback code remains

**Done:**
- [ ] Fallback code removed
- [ ] Method is simplified

## Task 2: Run test suite

**Type:** auto

**Files:**
- None (testing only)

**Action:**
Run the complete test suite to verify all tests still pass:

```bash
pytest tests/ -v --tb=short
```

If any tests fail, analyze and fix the custom parser (do NOT restore fallback).

**Verify:**
- All 528 tests pass
- No new failures

**Done:**
- [ ] Test suite passes
- [ ] Any failures documented and fixed

## Task 3: Test with real document

**Type:** auto

**Files:**
- None (testing only)

**Action:**
Process the real document to verify it still works:

```bash
livemathtex process /home/mark/Repositories/mark-private/private/axabio_confidential/business/abp_2026_2030/docs/astaxanthin_production_analysis.md -o /tmp/test.md
```

**Verify:**
- Document processes with 0 errors
- Same results as before

**Done:**
- [ ] Real document processes successfully
- [ ] Results verified

## Task 4: Clean up unused imports

**Type:** auto

**Files:**
- `src/livemathtex/engine/evaluator.py`

**Action:**
Check if `latex2sympy` is still used elsewhere in evaluator.py. If not used in `_compute_with_pint()`, check if it's used in `_compute()`.

If `latex2sympy` is still used in `_compute()`, keep the import.
If not used anywhere, remove the import.

**Verify:**
- No unused imports
- Code still works

**Done:**
- [ ] Import usage analyzed
- [ ] Unused imports removed (if any)
</tasks>

<verification>
## Verification Steps

1. Run expression evaluator tests: `pytest tests/test_expression_evaluator.py -v`
2. Run pint evaluator tests: `pytest tests/test_pint_evaluator.py -v`
3. Run full test suite: `pytest tests/ -v --tb=no`
4. Process real document
</verification>

<success_criteria>
- [ ] Fallback code removed from `_compute_with_pint()`
- [ ] All 528 tests pass
- [ ] Real document processes correctly
- [ ] No silent failures (errors propagate properly)
</success_criteria>

<output>
## Expected Output

Files modified:
- `src/livemathtex/engine/evaluator.py` - Remove fallback code

Commits:
1. `feat(27-01): remove latex2sympy fallback from _compute_with_pint`

Summary:
- `.planning/phases/27-remove-dependencies/27-01-SUMMARY.md`
</output>

<notes>
## Implementation Notes

### What stays
- `_compute()` still uses latex2sympy for variable expressions
- Function definitions still use sympy.Lambda
- Unit formatting still uses sympy.physics.units
- These are separate concerns for future phases

### Risk assessment
The custom parser has been validated with 528 tests. Removing the fallback is safe because:
1. All tests pass with custom parser first
2. Real document processes correctly
3. Fallback was never triggered in testing

### Future milestone (v4.0?)
To fully remove SymPy, would need:
1. Extend custom parser to handle variable expressions (for `:=`)
2. Replace Lambda with custom function representation
3. Replace sympy.physics.units with Pint formatting
</notes>
