---
phase: 12-unit-warnings
plan: 01
type: execute
---

<objective>
Distinguish calculation errors from formatting warnings in unit conversion.

Purpose: Fix ISS-017 - Unit conversion failures currently show as errors (red) even when the calculation itself succeeds. These are display/formatting issues, not calculation failures. Show them as warnings (orange) with SI fallback instead.
Output: Warning system with orange color for unit conversion issues, SI unit fallback, separate warning counter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-token-classification/11-01-SUMMARY.md

**Key files:**
@src/livemathtex/engine/evaluator.py (_apply_conversion, error formatting)
@src/livemathtex/render/markdown.py (metadata footer with error count)
@src/livemathtex/core.py (error detection patterns, metadata tracking)

**Issue being addressed:**
- ISS-017: Unit conversion failures need better diagnostics and should be warnings, not errors

**Current behavior (problem):**
- `$E := 650.67\ mol$ ... $E == [mol/day]$` → `Error: Unit conversion failed for 'mol/day'` (red)
- User doesn't know current unit is `mol` (not `mol/day`)
- Error count increases even though calculation succeeded
- SI base units could be shown instead of failing

**Expected behavior:**
- `$E == [mol/day]$` → `Warning: Cannot convert from 'mol' to 'mol/day' - dimensions incompatible. Showing: 650.67 mol` (orange)
- Warning count tracked separately from error count
- Footer shows "1 warning" distinct from errors

**Constraints:**
- Must not break existing error handling for real calculation failures
- Must preserve existing 348 tests
- Orange/yellow color must render in LaTeX math mode
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add warning formatting infrastructure</name>
  <files>src/livemathtex/engine/evaluator.py, src/livemathtex/utils/errors.py</files>
  <action>
1. **Add UnitConversionWarning exception in utils/errors.py:**
   ```python
   class UnitConversionWarning(Exception):
       """Warning for unit conversion failures (not calculation errors)."""
       def __init__(self, message: str, current_unit: str, target_unit: str, si_value: str):
           super().__init__(message)
           self.current_unit = current_unit
           self.target_unit = target_unit
           self.si_value = si_value  # Value in SI base units as string
   ```

2. **Update _apply_conversion in evaluator.py:**
   - Before attempting conversion, extract current unit from value using Pint
   - On conversion failure, raise UnitConversionWarning instead of ValueError
   - Include current unit, target unit, and SI representation in the exception

3. **Add warning formatting method:**
   ```python
   def _format_warning(self, message: str) -> str:
       """Format a warning message with orange color."""
       # Use \color{orange} for warnings (distinct from \color{red} for errors)
       return f"\\color{{orange}}{{\\text{{{message}}}}}"
   ```
  </action>
  <verify>python -c "from livemathtex.utils.errors import UnitConversionWarning; print('OK')"</verify>
  <done>UnitConversionWarning exception exists, _apply_conversion extracts and reports current unit</done>
</task>

<task type="auto">
  <name>Task 2: Handle warnings in evaluation flow and show SI fallback</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
1. **Update _handle_evaluation() to catch UnitConversionWarning:**
   - Catch UnitConversionWarning separately from other exceptions
   - For warnings: show result in SI units with orange warning message
   - Format: `$expr == {si_value}\n\\ \color{orange}{\text{Warning: ...}}$`

2. **Track warnings separately:**
   - Add `self._warning_count` counter in Evaluator
   - Increment on UnitConversionWarning
   - Add `get_warning_count()` method

3. **Update error message generation:**
   - Warnings use `\color{orange}` instead of `\color{red}`
   - Warning message format: "Cannot convert from '{current}' to '{target}'. Showing value in SI units."
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -c "
from livemathtex.core import process_text
# This should produce a warning, not an error
result, ir = process_text('\$x := 5\\ mol\$\n\n\$y := x == ?\ [mol/day]\$')
print('color{orange}' in result or 'Warning' in result)
print(result[:500])
"</verify>
  <done>Unit conversion failures produce orange warnings with SI fallback, warning counter works</done>
</task>

<task type="auto">
  <name>Task 3: Update metadata tracking and clear patterns</name>
  <files>src/livemathtex/core.py, src/livemathtex/render/markdown.py</files>
  <action>
1. **Update core.py metadata tracking:**
   - Add 'warnings' to metadata dict alongside 'errors'
   - Update `_do_process_text()` and `_do_process_text_with_ir()` to track warnings
   - Get warning count from evaluator after processing

2. **Update render/markdown.py footer:**
   - Add warnings to footer display
   - Format: "1 warning" or "2 warnings" after errors
   - Example: "3 definitions, 2 evaluations | no errors, 1 warning | 0.05s"

3. **Update clear_text patterns in core.py:**
   - Add pattern for `\color{orange}` warning markup removal
   - Ensure warnings are cleared same as errors on re-process
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -c "
from livemathtex.core import process_text
result, ir = process_text('\$x := 5\\ mol\$\n\$y := x == ?\ [mol/day]\$')
# Check for warning in footer
print('warning' in result.lower())
print(result[-300:])
"</verify>
  <done>Footer shows warning count, clear_text removes orange markup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `from livemathtex.utils.errors import UnitConversionWarning` works
- [ ] Unit conversion failures show `\color{orange}` not `\color{red}`
- [ ] Warning message includes current unit and target unit
- [ ] SI fallback value is displayed
- [ ] Footer shows warning count separate from errors
- [ ] `clear_text()` removes orange warning markup
- [ ] All 348+ existing tests still pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-017 addressed: unit conversion failures are warnings with SI fallback
- Error count remains accurate (warnings tracked separately)
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/12-unit-warnings/12-01-SUMMARY.md`
</output>
