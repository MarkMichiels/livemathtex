---
phase: 02-bug-fixes
plan: 03
type: tdd
subsystem: engine
tags: [evaluator, pint, units, dimensional-analysis, tdd]
---

<objective>
Fix ISSUE-006: Detect and error on incompatible unit operations (e.g., kg + m).

Purpose: Prevent silent wrong results when adding/subtracting quantities with incompatible dimensions.
Output: Dimensional compatibility checking with clear error messages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fix/01-01-SUMMARY.md
@.planning/phases/02-medium-bugs/02-01-SUMMARY.md (if exists)
@.planning/phases/02-medium-bugs/02-02-SUMMARY.md (if exists)

**Key files:**
@src/livemathtex/engine/evaluator.py
@src/livemathtex/engine/pint_backend.py
@docs/BACKLOG.md (ISSUE-006 section)

**From BACKLOG.md ISSUE-006:**
- Problem: `5 kg + 3 m` silently evaluates to `8` (wrong!)
- Root cause: SymPy doesn't enforce dimensional analysis
- Solution: Pre-check dimensional compatibility before evaluation (Option A)
- Impact: Silent wrong results, cascading errors, false confidence

**Constraining decisions:**
- Phase 1: TDD approach proven effective for bug fixes
- Pint is single source of truth for units
- Error messages should be clear and actionable
</context>

<feature>
  <name>Dimensional compatibility checking for Add/Sub operations</name>
  <files>src/livemathtex/engine/evaluator.py, src/livemathtex/engine/pint_backend.py, tests/test_dimensional_analysis.py</files>
  <behavior>
    When evaluating an expression containing addition or subtraction:
    1. Check if operands have units
    2. If both have units, verify they are dimensionally compatible
    3. If incompatible, raise error with clear message

    Test cases:
    - `5 kg + 3 m` → Error: "Cannot add incompatible units: kg and m"
    - `10 s - 5 m/s` → Error: "Cannot subtract incompatible units: s and m/s"
    - `5 kg + 3 kg` → OK: 8 kg
    - `1 km + 500 m` → OK: 1500 m (or 1.5 km)
    - `5 + 3` → OK: 8 (unitless)
    - `5 kg + 3` → OK or Error? (mixed unit/unitless - decide)
  </behavior>
  <implementation>
    Option A from BACKLOG: Pre-check dimensional compatibility

    1. Add `get_term_dimension()` to pint_backend.py:
       - Extract unit from a SymPy term
       - Return Pint dimensionality or None for unitless

    2. Add `check_dimensional_compatibility()` to evaluator.py:
       - Detect Add/Sub expressions in SymPy AST
       - For each term, get its dimension
       - If dimensions differ, raise ValueError

    3. Call check before evaluation in `_compute()`
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for dimensional compatibility (RED)</name>
  <files>tests/test_dimensional_analysis.py</files>
  <action>
Create new test file `tests/test_dimensional_analysis.py`:

```python
"""Tests for ISSUE-006: Dimensional compatibility checking."""
import pytest
from livemathtex.core import process_text

class TestIncompatibleUnits:
    """Test that incompatible unit operations produce errors."""

    def test_kg_plus_m_raises_error(self):
        """Adding kg + m should produce an error."""
        result = process_text("$m_1 := 5\\ kg$\n$d_1 := 3\\ m$\n$bad := m_1 + d_1 ==$")
        assert "Error" in result
        # Should mention incompatible units
        assert "kg" in result.lower() or "incompatible" in result.lower()

    def test_seconds_minus_velocity_raises_error(self):
        """Subtracting s - m/s should produce an error."""
        result = process_text("$t_1 := 10\\ s$\n$v_1 := 5\\ \\frac{m}{s}$\n$bad := t_1 - v_1 ==$")
        assert "Error" in result

    def test_three_incompatible_terms(self):
        """Multiple incompatible terms should error."""
        result = process_text("$a := 1\\ kg$\n$b := 2\\ m$\n$c := 3\\ s$\n$bad := a + b + c ==$")
        assert "Error" in result


class TestCompatibleUnits:
    """Test that compatible unit operations work correctly."""

    def test_kg_plus_kg_works(self):
        """Adding kg + kg should work."""
        result = process_text("$m_1 := 5\\ kg$\n$m_2 := 3\\ kg$\n$total := m_1 + m_2 ==$")
        assert "Error" not in result
        assert "8" in result

    def test_km_plus_m_works(self):
        """Adding km + m (same dimension, different scale) should work."""
        result = process_text("$d_1 := 1\\ km$\n$d_2 := 500\\ m$\n$total := d_1 + d_2 ==$")
        assert "Error" not in result
        # Result should be 1500 m or 1.5 km

    def test_unitless_addition_works(self):
        """Adding unitless numbers should work."""
        result = process_text("$a := 5$\n$b := 3$\n$c := a + b ==$")
        assert "Error" not in result
        assert "8" in result


class TestEdgeCases:
    """Test edge cases for dimensional analysis."""

    def test_multiplication_different_units_ok(self):
        """Multiplying different units should work (kg * m = kg*m)."""
        result = process_text("$m_1 := 5\\ kg$\n$d_1 := 3\\ m$\n$prod := m_1 \\cdot d_1 ==$")
        assert "Error" not in result

    def test_division_different_units_ok(self):
        """Dividing different units should work (m / s = m/s)."""
        result = process_text("$d_1 := 10\\ m$\n$t_1 := 2\\ s$\n$v := d_1 / t_1 ==$")
        assert "Error" not in result
```

Run tests - they MUST fail (currently no dimensional checking).
  </action>
  <verify>pytest tests/test_dimensional_analysis.py -v shows failing tests for incompatible units</verify>
  <done>Test file created with 9 tests, incompatible unit tests fail (as expected)</done>
</task>

<task type="auto">
  <name>Task 2: Implement dimensional compatibility checking (GREEN)</name>
  <files>src/livemathtex/engine/pint_backend.py, src/livemathtex/engine/evaluator.py</files>
  <action>
**Step 1: Add helper function to pint_backend.py:**

```python
def get_unit_dimensionality(unit_expr) -> Optional[str]:
    """
    Get the dimensionality string for a unit expression.

    Args:
        unit_expr: A Pint unit or SymPy unit expression

    Returns:
        Dimensionality string like '[mass]', '[length]', '[time]', or None for unitless
    """
    if unit_expr is None:
        return None

    ureg = get_unit_registry()
    try:
        # Convert to Pint if needed
        if hasattr(unit_expr, 'dimensionality'):
            return str(unit_expr.dimensionality)
        # Try parsing as unit string
        pint_unit = ureg.Unit(str(unit_expr))
        return str(pint_unit.dimensionality)
    except:
        return None
```

**Step 2: Add dimensional check to evaluator.py:**

In `_compute()` or the evaluation flow, before evaluating Add/Sub expressions:

```python
def _check_dimensional_compatibility(self, expr, symbol_table):
    """
    Check that Add/Sub expressions have dimensionally compatible terms.

    Raises ValueError if incompatible units are being added/subtracted.
    """
    from sympy import Add

    if not isinstance(expr, Add):
        return  # Only check addition/subtraction

    term_units = []
    for term in expr.args:
        # Extract the unit from this term
        unit = self._extract_unit_from_term(term, symbol_table)
        if unit is not None:
            term_units.append((term, unit))

    if len(term_units) < 2:
        return  # Not enough units to compare

    # Check all units have same dimensionality
    first_dim = get_unit_dimensionality(term_units[0][1])
    for term, unit in term_units[1:]:
        dim = get_unit_dimensionality(unit)
        if dim != first_dim:
            raise ValueError(
                f"Cannot add/subtract incompatible units: "
                f"{term_units[0][1]} ({first_dim}) and {unit} ({dim})"
            )
```

**Step 3: Call the check before evaluation**

In the evaluation flow (likely in `_compute()` or `evaluate()`), add:
```python
self._check_dimensional_compatibility(expr, self.symbol_table)
```

Make sure errors are caught and displayed inline like other errors.
  </action>
  <verify>pytest tests/test_dimensional_analysis.py -v shows all tests passing</verify>
  <done>Dimensional compatibility checking implemented, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Update error-handling example and documentation</name>
  <files>examples/error-handling/input.md, docs/BACKLOG.md</files>
  <action>
1. Add Category 6 to examples/error-handling/input.md (before "Correct Usage Reference"):

```markdown
---

## Category 6: Dimension Mismatch Errors

Adding or subtracting quantities with incompatible dimensions produces an error.

### Error: Adding mass and length

$mass_1 := 5\ kg$
$dist_1 := 3\ m$
$invalid := mass_1 + dist_1 ==$

**Explanation:** Cannot add kilograms (mass) to meters (length). These have different physical dimensions.

### Error: Subtracting time and velocity

$time_1 := 10\ s$
$vel_1 := 5\ \frac{m}{s}$
$invalid_2 := time_1 - vel_1 ==$

**Explanation:** Cannot subtract velocity from time.

### Multiplication and division are OK

Different units CAN be multiplied or divided:

$force := mass_1 \cdot 9.81 ==$
$velocity := dist_1 / time_1 ==$

---
```

2. Update Error Summary table to include dimension mismatch.

3. Process the example to generate output.md.

4. Update BACKLOG.md:
   - Mark ISSUE-006 as resolved
   - Add resolution date and solution summary
  </action>
  <verify>livemathtex process examples/error-handling/input.md shows dimension errors correctly</verify>
  <done>Error-handling example updated, BACKLOG.md shows ISSUE-006 resolved</done>
</task>

<task type="auto">
  <name>Task 4: Run full test suite and verify no regressions</name>
  <files>tests/</files>
  <action>
1. Run full test suite: `pytest tests/ -v`
2. Ensure all tests pass (no regressions)
3. Verify the example files process correctly
4. Check that existing calculations still work (multiplication, division, compatible addition)
  </action>
  <verify>pytest tests/ -v shows all tests passing</verify>
  <done>All tests pass, Phase 2 complete (ISSUE-004, ISSUE-005, ISSUE-006 all resolved)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_dimensional_analysis.py -v` - all dimensional tests pass
- [ ] `pytest tests/ -v` - full suite passes (no regressions)
- [ ] `5 kg + 3 m` produces clear error message
- [ ] `5 kg + 3 kg` works correctly (result: 8 kg)
- [ ] `5 kg * 3 m` works correctly (different units in multiplication OK)
- [ ] ISSUE-006 marked resolved in BACKLOG.md
- [ ] examples/error-handling/ updated with dimension mismatch category
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Incompatible unit operations produce clear errors
- Compatible operations still work correctly
- Multiplication/division of different units still works
- Phase 2 complete (all 3 issues resolved)
</success_criteria>

<output>
After completion, create `.planning/phases/02-medium-bugs/02-03-SUMMARY.md` following summary.md template with:
- RED: What tests were written, why they failed
- GREEN: What implementation made them pass
- Files created/modified
- Decisions made (e.g., how to handle mixed unit/unitless)
- Phase 2 complete, ready for Phase 3 (API Features)
</output>
