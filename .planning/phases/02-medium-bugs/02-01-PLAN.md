---
phase: 02-medium-bugs
plan: 01
type: execute
subsystem: parser
tags: [lexer, directives, code-blocks, regex]
---

<objective>
Fix ISSUE-004: Directive parser should skip fenced code blocks.

Purpose: Prevent example directives in documentation from being parsed as real configuration.
Output: `parse_document_directives()` ignores content inside ``` and ~~~ fences.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fix/01-01-SUMMARY.md

**Key files:**
@src/livemathtex/parser/lexer.py

**From BACKLOG.md ISSUE-004:**
- Problem: `parse_document_directives()` scans raw content without skipping code blocks
- Solution: Strip fenced code blocks before regex scanning
- Approach: `re.sub(r'```[\s\S]*?```', '', content)` before directive search

**Constraining decisions:**
- Phase 1: TDD approach proven effective for bug fixes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing test for code block directive parsing</name>
  <files>tests/test_lexer_directives.py</files>
  <action>
Create new test file `tests/test_lexer_directives.py` with tests for ISSUE-004:

```python
def test_directive_in_code_block_ignored():
    """Directives inside code blocks should NOT be parsed."""
    content = '''<!-- livemathtex: digits=4 -->

Example:
```markdown
<!-- livemathtex: output=inplace -->
```
'''
    lexer = Lexer()
    directives = lexer.parse_document_directives(content)
    assert directives == {'digits': 4}
    assert 'output' not in directives

def test_directive_in_tilde_code_block_ignored():
    """Directives inside ~~~ code blocks should NOT be parsed."""
    content = '''<!-- livemathtex: format=engineering -->

~~~
<!-- livemathtex: digits=2 -->
~~~
'''
    lexer = Lexer()
    directives = lexer.parse_document_directives(content)
    assert directives == {'format': 'engineering'}
    assert 'digits' not in directives

def test_multiple_code_blocks_all_ignored():
    """Multiple code blocks should all be stripped."""
    # ... additional edge cases
```

Run tests - they MUST fail (directives in code blocks are currently parsed).
  </action>
  <verify>pytest tests/test_lexer_directives.py -v shows failing tests</verify>
  <done>Test file created with 3+ failing tests demonstrating the bug</done>
</task>

<task type="auto">
  <name>Task 2: Implement code block stripping in parse_document_directives</name>
  <files>src/livemathtex/parser/lexer.py</files>
  <action>
Modify `parse_document_directives()` method in Lexer class (around line 325):

1. Before the `for match in self.DOCUMENT_DIRECTIVE_RE.finditer(content):` line, add:
```python
# Strip fenced code blocks before scanning for directives (ISSUE-004)
# This prevents example directives in documentation from being parsed
content_for_scan = re.sub(r'```[\s\S]*?```', '', content)
content_for_scan = re.sub(r'~~~[\s\S]*?~~~', '', content_for_scan)
```

2. Change the loop to use `content_for_scan` instead of `content`:
```python
for match in self.DOCUMENT_DIRECTIVE_RE.finditer(content_for_scan):
```

This is the simplest solution - strip code blocks from a temporary copy used only for directive scanning.

Do NOT modify the original `content` variable as it may be used elsewhere.
  </action>
  <verify>pytest tests/test_lexer_directives.py -v shows all tests passing</verify>
  <done>All directive tests pass, code blocks are now ignored</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and update BACKLOG</name>
  <files>docs/BACKLOG.md</files>
  <action>
1. Run full test suite: `pytest tests/ -v`
2. Ensure all 115+ existing tests still pass
3. Update docs/BACKLOG.md:
   - Change ISSUE-004 status from "ðŸŸ¡ OPEN" to "âœ… RESOLVED"
   - Add "Resolved: 2026-01-11" date
   - Add brief "Solution implemented" section describing the fix
  </action>
  <verify>pytest tests/ -v shows all tests passing (no regressions)</verify>
  <done>All tests pass, BACKLOG.md updated with ISSUE-004 resolution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_lexer_directives.py -v` - all directive tests pass
- [ ] `pytest tests/ -v` - full suite passes (no regressions)
- [ ] ISSUE-004 marked resolved in BACKLOG.md
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Directives inside code blocks are ignored
- Existing behavior preserved for directives outside code blocks
</success_criteria>

<output>
After completion, create `.planning/phases/02-medium-bugs/02-01-SUMMARY.md` following summary.md template with:
- RED: What test was written, why it failed
- GREEN: What implementation made it pass
- Files created/modified
- Decisions made
- Ready for 02-02-PLAN.md
</output>
