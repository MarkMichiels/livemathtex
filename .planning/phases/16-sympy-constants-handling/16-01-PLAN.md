---
phase: 16-sympy-constants-handling
plan: 01
type: execute
---

<objective>
Fix `evaluate_sympy_ast_with_pint()` to handle SymPy mathematical constants (π, e) and fix unsafe isinstance() check for SympyQuantity.

Purpose: Enable calculations containing mathematical constants like π and e to evaluate correctly instead of crashing with isinstance() error.
Output: Working evaluation of expressions with π, e, and other SymPy constants. All tests pass.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md - ISS-025 details
@src/livemathtex/engine/pint_backend.py - evaluate_sympy_ast_with_pint() function

**Issue Summary (ISS-025):**
1. Missing handlers for SymPy constants: Pi, Exp1, EulerGamma, GoldenRatio, Catalan, ImaginaryUnit, Infinity
2. Unsafe isinstance(e, SympyQuantity) check on line 2221 - if import fails, SympyQuantity becomes None and isinstance crashes

**Technical Context:**
- SymPy constants inherit from `sympy.core.numbers.NumberSymbol`, NOT from `sympy.Number`
- `float(sympy.pi)` works correctly → 3.141592653589793
- Need to add handler BEFORE the isinstance(e, SympyQuantity) check falls through
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add handlers for SymPy mathematical constants</name>
  <files>src/livemathtex/engine/pint_backend.py</files>
  <action>
  In the `_eval()` function inside `evaluate_sympy_ast_with_pint()`, add handlers for SymPy constants AFTER the Symbol handler (around line 2218) and BEFORE the SympyQuantity check (line 2221):

  1. Add import at top of function (if not already): `import sympy.core.numbers`
  2. Add handler for NumberSymbol (base class for Pi, Exp1, etc.):
     ```python
     # SymPy mathematical constants (Pi, E, EulerGamma, etc.)
     # These inherit from NumberSymbol, not Number
     if isinstance(e, sympy.core.numbers.NumberSymbol):
         val = float(e)
         return val * ureg.dimensionless if allow_dimensionless else val
     ```
  3. This handles: Pi, Exp1 (e), EulerGamma, GoldenRatio, Catalan

  Do NOT handle Infinity, ComplexInfinity, or ImaginaryUnit - these are edge cases that should raise errors for physical calculations.
  </action>
  <verify>python -c "from livemathtex.engine.pint_backend import evaluate_sympy_ast_with_pint; import sympy; print(evaluate_sympy_ast_with_pint(sympy.pi * 2, {}))" should return ~6.28</verify>
  <done>Expressions with π and e evaluate to correct numeric values</done>
</task>

<task type="auto">
  <name>Task 2: Fix unsafe isinstance(e, SympyQuantity) check</name>
  <files>src/livemathtex/engine/pint_backend.py</files>
  <action>
  Wrap the SympyQuantity isinstance check in try/except to handle import failures gracefully:

  Replace (around line 2220-2227):
  ```python
  # SymPy Quantity (unit) - convert to Pint
  if isinstance(e, SympyQuantity):
      ...
  ```

  With:
  ```python
  # SymPy Quantity (unit) - convert to Pint
  # Guard against SympyQuantity being None if import failed
  if SympyQuantity is not None and isinstance(e, SympyQuantity):
      unit_name = str(e)
      pint_unit = _sympy_unit_to_pint(unit_name)
      if pint_unit is not None:
          return 1 * pint_unit
      raise PintEvaluationError(f"Unknown unit: {unit_name}")
  ```

  This ensures if `from sympy.physics.units import Quantity as SympyQuantity` fails, the check is skipped rather than crashing.
  </action>
  <verify>pytest tests/test_pint_evaluator.py -v passes</verify>
  <done>No isinstance() crash when SympyQuantity import fails</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for SymPy constants</name>
  <files>tests/test_pint_evaluator.py</files>
  <action>
  Add test class `TestSymPyConstants` with tests:

  1. `test_pi_in_expression` - Test `$d := \frac{2 \cdot x}{\pi} ==$` with `$x := 38\ mm$` → expect ~24.19 mm
  2. `test_pi_times_r_squared` - Test `$A := \pi \cdot r^2 ==$` with `$r := 5\ m$` → expect ~78.54 m²
  3. `test_e_in_expression` - Test `$y := e^{x} ==$` with `$x := 1$` → expect ~2.718 (dimensionless)
  4. `test_two_pi` - Test `$\omega := 2 \cdot \pi ==$` → expect ~6.283 (dimensionless)

  Use `pytest.approx()` for floating point comparisons.
  </action>
  <verify>pytest tests/test_pint_evaluator.py::TestSymPyConstants -v passes</verify>
  <done>4+ tests covering π and e in various contexts</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] pytest tests/ -v passes (all tests including new ones)
- [ ] Expression `$d := \frac{2 \cdot x}{\pi} ==$` with `$x := 38\ mm$` evaluates to ~24.19 mm
- [ ] No isinstance() errors in any test
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-025 fixed: SymPy constants (π, e) work in calculations
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/16-sympy-constants-handling/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Fix SymPy Constants Handling Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/livemathtex/engine/pint_backend.py` - Added NumberSymbol handler, fixed SympyQuantity check
- `tests/test_pint_evaluator.py` - Added TestSymPyConstants class

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Ready for Phase 17 or describe any blockers]
</output>
