# Phase 3 Plan 1: Fix Evaluation Unit Lookup for Custom Division Units

## Objective

Fix ISS-009: Standalone `$var ==$ <!-- [SEC] -->` evaluations fail when SEC is defined with division (e.g., `SEC === MWh/kg`). The unit IS registered in the SymPy registry, but `_parse_unit_expression` fails to resolve compound expressions containing prefixed units.

## Execution Context

- **Files:** `src/livemathtex/engine/pint_backend.py`, `tests/test_pint_backend.py`
- **Dependencies:** Phase 2 complete (v1.3)
- **TDD:** Yes - write failing test first

## Context

### Root Cause Analysis

`_define_derived_unit("SEC", "MWh/kg")` fails to create a proper SymPy unit because:

1. `_parse_unit_expression("MWh/kg")` builds a namespace with only base units (watt, kg, etc.)
2. "MWh" is NOT in the namespace (only 'W' and 'watt')
3. `eval("MWh/kg", {}, namespace)` fails with NameError
4. Code falls through to line 1594: `sympy_unit = Quantity(name, abbrev=name)`
5. This creates a bare `Quantity("SEC")` with NO dimensional relationship to energy/mass
6. When `_apply_conversion` divides value (J/kg) by SEC (dimensionless), result has units
7. `float(ratio_base)` fails, exception is silently caught, original value returned

### Working vs Failing

- **Works:** `$SEC_result := E / m ==$ <!-- [SEC] -->` - value computed fresh with SymPy units
- **Fails:** `$ratio ==$ <!-- [SEC] -->` - value from symbol table with SI units, custom unit lookup broken

### Fix Strategy

Enhance `_parse_unit_expression` to resolve prefixed units (MWh, kW, kJ) by:
1. Adding prefixed units to namespace via `pint_to_sympy_with_prefix`
2. OR tokenizing expression and resolving each token individually

### Additional Issues Discovered

1. **Silent failure in `_apply_conversion`** (lines 1183-1185): All exceptions are caught and original value returned silently. This masks the real problem - should raise/log an error.

2. **No protection against overwriting existing units**: `define_unit` doesn't check if the unit name already exists in Pint's registry before defining it with `===`.

## Tasks

### Task 1: Add Failing Test for ISS-009

**File:** `tests/test_pint_backend.py`

Add test class `TestCustomUnitWithDivision`:

```python
class TestCustomUnitWithDivision:
    """Tests for ISS-009: Custom units defined with division."""

    def test_define_division_unit_sympy_lookup(self):
        """SEC === MWh/kg should create proper SymPy unit."""
        from livemathtex.engine.pint_backend import (
            get_sympy_unit_registry, reset_sympy_unit_registry
        )
        from sympy.physics.units import mega, watt, hour, kilogram

        reset_sympy_unit_registry()
        registry = get_sympy_unit_registry()

        # Define SEC as MWh/kg
        registry.define_unit('SEC === MWh/kg')

        # Get the unit
        sec_unit = registry.get_unit('SEC')

        # It should NOT be a bare Quantity with no dimensions
        assert sec_unit is not None

        # It should be equivalent to MWh/kg = mega*watt*hour/kilogram
        expected = mega * watt * hour / kilogram

        # Check dimensional equivalence (ratio should be dimensionless number)
        from sympy.physics.units import convert_to, kg, m, s, A, K, mol, cd
        ratio = sec_unit / expected
        ratio_base = convert_to(ratio, [kg, m, s, A, K, mol, cd])

        # Should be 1.0 (same dimensions)
        assert float(ratio_base) == 1.0
```

**Checkpoint:** Test fails with `float()` error or incorrect ratio

### Task 2: Fix _parse_unit_expression to Handle Prefixed Units

**File:** `src/livemathtex/engine/pint_backend.py`

Modify `_parse_unit_expression` (around line 1606) to add prefixed units to namespace:

```python
def _parse_unit_expression(self, expr: str) -> Optional[Any]:
    """Parse a unit expression like 'bar/1000' or 'kW * h'."""
    expr = expr.replace('\\cdot', '*').replace('\\times', '*').replace('\\div', '/')

    # Build namespace from custom units
    namespace = {}
    for name, unit_def in self._custom_units.items():
        namespace[name] = unit_def.sympy_unit

    # Add SymPy base units and prefixes
    namespace.update({
        'bar': bar, 'day': day, 'hour': hour, 'watt': watt,
        'liter': liter, 'gram': gram, 'meter': meter, 'second': second,
        'kilogram': kilogram, 'kilo': kilo, 'milli': milli, 'micro': micro,
        'centi': centi, 'joule': joule, 'pascal': pascal, 'hertz': hertz,
        'volt': volt, 'ampere': ampere, 'ohm': ohm, 'kelvin': kelvin,
        'minute': minute, 'milligram': milligram,
        'm': meter, 's': second, 'kg': kilogram, 'g': gram,
        'h': hour, 'min': minute, 'W': watt, 'J': joule,
        'Pa': pascal, 'Hz': hertz, 'V': volt, 'A': ampere,
        'K': kelvin, 'L': liter, 'N': newton, 'newton': newton,
    })

    # NEW: Add prefixed units that aren't in the base namespace
    # Extract tokens from expression and resolve via pint_to_sympy_with_prefix
    import re
    tokens = re.findall(r'[A-Za-z]\w*', expr)
    for token in tokens:
        if token not in namespace:
            sympy_unit = pint_to_sympy_with_prefix(token)
            if sympy_unit is not None:
                namespace[token] = sympy_unit

    try:
        return eval(expr, {"__builtins__": {}}, namespace)
    except Exception:
        return None
```

**Checkpoint:** Test from Task 1 passes

### Task 3: Add Integration Test for Standalone Evaluation

**File:** `tests/test_pint_backend.py`

Add to `TestCustomUnitWithDivision`:

```python
def test_standalone_evaluation_with_custom_division_unit(self):
    """Standalone $var ==$ should work with division-based custom units."""
    from livemathtex import process_text

    input_text = '''
$$ SEC === MWh/kg $$

$E := 18000\\ MWh$

$m := 1000\\ kg$

$ratio := E / m$

$ratio ==$ <!-- [SEC] -->
'''
    result = process_text(input_text)

    # Should show "18 SEC" not a raw number like "1.8e10"
    assert '18' in result
    assert 'SEC' in result
    assert '1.8' not in result  # Not SI value
```

**Checkpoint:** Integration test passes

### Task 4: Remove Silent Failure in _apply_conversion

**File:** `src/livemathtex/engine/evaluator.py`

Replace the catch-all exception handler (lines 1183-1185):

```python
# BEFORE (BAD - silent failure)
except Exception as e:
    # Fallback if conversion fails for other reasons
    return value, ""

# AFTER (GOOD - explicit error)
except Exception as e:
    # Don't silently swallow errors - raise with context
    raise ValueError(
        f"Unit conversion failed for '{target_unit_latex}': {e}. "
        f"Check that the unit is properly defined."
    ) from e
```

**Checkpoint:** Invalid unit conversions now raise clear errors

### Task 5: Add Protection Against Overwriting Existing Units

**File:** `src/livemathtex/engine/pint_backend.py`

In `SymPyUnitRegistry.define_unit()` (around line 1546), add check before defining:

```python
def define_unit(self, latex: str) -> Optional[UnitDefinition]:
    """Parse and register a unit definition from === syntax."""
    if '===' not in latex:
        return None

    parts = latex.split('===')
    if len(parts) != 2:
        return None

    left = self._clean_unit_name(parts[0].strip())
    right = self._clean_unit_name(parts[1].strip())

    # NEW: Check if unit already exists in Pint
    if is_pint_unit(left):
        raise ValueError(
            f"Cannot redefine existing unit '{left}'. "
            f"Choose a different name for your custom unit."
        )

    # Base unit (X === X)
    if left == right:
        return self._define_base_unit(left)

    # Derived/compound/alias
    return self._define_derived_unit(left, right)
```

**Checkpoint:** Attempting to redefine existing units raises error

### Task 6: Add Tests for Error Handling

**File:** `tests/test_pint_backend.py`

```python
def test_redefine_existing_unit_raises_error(self):
    """Attempting to redefine kg should raise error."""
    from livemathtex.engine.pint_backend import get_sympy_unit_registry, reset_sympy_unit_registry
    import pytest

    reset_sympy_unit_registry()
    registry = get_sympy_unit_registry()

    # kg is a Pint unit - should not be overwritable
    with pytest.raises(ValueError, match="Cannot redefine existing unit"):
        registry.define_unit('kg === 1000 g')

def test_invalid_unit_conversion_raises_error(self):
    """Invalid unit in conversion should raise, not silently fail."""
    from livemathtex import process_text
    import pytest

    input_text = '''
$x := 100\\ m$

$x ==$ <!-- [UNDEFINED_UNIT] -->
'''
    with pytest.raises(ValueError, match="Unrecognized unit"):
        process_text(input_text)
```

**Checkpoint:** Tests verify error handling works

### Task 7: Add Error Examples to Documentation

**File:** `examples/errors/` (new directory)

Create `examples/errors/input.md`:

```markdown
# Error Examples

This document demonstrates error handling in LiveMathTeX.

## Undefined Unit in Conversion

Using an undefined unit in a conversion hint causes an error:

$x := 100\ m$

$x ==$ <!-- [UNDEFINED_UNIT] -->

**Expected error:** `Unrecognized unit in comment: 'UNDEFINED_UNIT'. Define it first with '$$ UNDEFINED_UNIT === ... $$'`

## Redefining Existing Units

Attempting to redefine a built-in unit like `kg` is not allowed:

$$ kg === 1000\ g $$

**Expected error:** `Cannot redefine existing unit 'kg'. Choose a different name for your custom unit.`

## Correct Custom Unit Definition

Custom units must use unique names:

$$ SEC === MWh/kg $$

$E := 18000\ MWh$

$m := 1000\ kg$

$ratio := E / m$

$ratio ==$ <!-- [SEC] -->
```

**Checkpoint:** Error examples documented

### Task 8: Run Full Test Suite

```bash
cd /home/mark/Repositories/livemathtex
pytest tests/ -v
```

**Checkpoint:** All tests pass (expected: 180+)

## Verification

```bash
# Quick verification
cd /home/mark/Repositories/livemathtex
pytest tests/test_pint_backend.py::TestCustomUnitWithDivision -v

# Full suite
pytest tests/ -v --tb=short
```

## Success Criteria

- [ ] Test for SymPy unit lookup passes (SEC has correct dimensions)
- [ ] Test for standalone evaluation passes (shows "18 SEC" not raw number)
- [ ] Invalid unit conversions raise clear errors (no silent failures)
- [ ] Redefining existing units raises error
- [ ] Full test suite passes (no regressions)
- [ ] ISS-009 can be closed

## Output

- Updated `pint_backend.py`:
  - `_parse_unit_expression` resolves prefixed units
  - `define_unit` checks for existing units before defining
- Updated `evaluator.py`:
  - `_apply_conversion` raises error instead of silent fallback
- New test class `TestCustomUnitWithDivision` in `test_pint_backend.py`
- New `examples/errors/input.md` documenting error cases
- ISS-009 marked as resolved in ISSUES.md
