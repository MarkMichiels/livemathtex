---
phase: 10-clear-refactor
plan: 01
type: execute
---

<objective>
Rewrite `clear_text()` to use span-based operations instead of regex patterns.

Purpose: Fix document corruption issues (ISS-021) where multiline error blocks cause merged math blocks and orphan fragments when clearing.
Output: Robust `clear_text()` function using Phase 8/9 parsers that preserves document structure.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-markdown-parser-integration/08-01-SUMMARY.md
@.planning/phases/09-structural-math-parsing/09-01-SUMMARY.md

**Key files:**
@src/livemathtex/parser/markdown_parser.py
@src/livemathtex/parser/calculation_parser.py
@src/livemathtex/core.py (current clear_text implementation)

**Tech available from prior phases:**
- `extract_math_blocks()` → List[ParsedMathBlock] with doc_start_offset, doc_end_offset, inner_content
- `parse_math_block_calculations()` → List[ParsedCalculation] with operation, result_span, operator_span
- `Span` dataclass with extract(text) helper

**Issue being addressed:**
- ISS-021: `livemathtex clear` can corrupt documents around multiline error blocks
- Root cause: regex patterns don't reliably consume full multiline error blocks and can merge adjacent math blocks

**Established patterns:**
- All spans are document-relative offsets
- ParsedCalculation.result_span points to the result portion after `==`
- Operations include: `===`, `:=`, `==`, `=>`, `:=_==`, `value`, `ERROR`
- For `==` and `:=_==`, result_span contains content to clear
- For `:=`, `===`, `=>`, no clearing needed (definitions/symbolic)

**Constraints:**
- Must preserve definitions (`:=`)
- Must preserve unit definitions (`===`)
- Must preserve symbolic results (`=>`)
- Must preserve inline unit hints `[unit]`
- Must preserve HTML comment unit hints `<!-- [unit] -->`
- Must clear evaluation results after `==`
- Must clear error markup `\color{red}{...}`
- Must preserve document structure (no merging of math blocks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement span-based clear_text_v2</name>
  <files>src/livemathtex/core.py</files>
  <action>
Create new function `clear_text_v2(content: str) -> tuple[str, int]` that uses span-based operations:

1. **Parse document structure:**
   ```python
   from .parser.markdown_parser import extract_math_blocks
   from .parser.calculation_parser import parse_math_block_calculations, ParsedCalculation
   ```

2. **Identify spans to clear** by iterating math blocks:
   - For each block, call `parse_math_block_calculations(block)`
   - For calculations with `operation == "=="` or `operation == ":=_=="`:
     - result_span contains content to remove
     - But preserve unit hints: check for `[unit]` pattern at end of result
   - For `operation == "ERROR"`: entire calculation needs error markup removed
   - Track spans to clear in reverse document order (to maintain offsets)

3. **Handle error markup separately:**
   - After identifying calculation result spans, scan for remaining `\color{red}{...}` patterns
   - Use regex ONLY for error markup removal (not for structure manipulation)

4. **Apply span-based edits:**
   - Sort spans by start offset, descending (clear from end to start)
   - For each span, replace `text[span.start:span.end]` with cleared content
   - For `==` results: replace with empty or `[unit]` if unit hint present
   - For error markup: remove entirely

5. **Handle metadata comment:**
   - Still use regex for `livemathtex-meta` comment (simple, safe pattern)

6. **Clean up whitespace:**
   - Remove excessive newlines (keep max 2)

Key difference from old implementation: We DON'T use regex to find math block boundaries - we use the parser which correctly handles all edge cases.

Place function BELOW existing `clear_text()` - we'll keep both temporarily.
  </action>
  <verify>python -c "from livemathtex.core import clear_text_v2; print('OK')"</verify>
  <done>Function importable and callable</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for span-based clear with ISS-021 cases</name>
  <files>tests/test_clear_v2.py</files>
  <action>
Create comprehensive test file for the new clear function:

**1. Basic clearing tests:**
- Clear single inline evaluation `$x == 5$` → `$x ==$`
- Clear display block evaluation `$$y == 10$$` → `$$y ==$$`
- Clear combined `:=_==` keeps definition: `$x := 5 == 5$` → `$x := 5 ==$`

**2. Unit hint preservation:**
- Inline unit hint preserved: `$E == 100 [kJ]$` stays as `$E == [kJ]$`
- Extract unit from `\text{kJ}` in result and restore as `[kJ]`
- HTML comment hints outside math are untouched

**3. Definition preservation:**
- `:=` definitions untouched: `$x := 5$` → `$x := 5$`
- `===` unit definitions untouched: `$kWh === 3600000 \cdot J$`
- `=>` symbolic untouched: `$\frac{a}{b} => c$`

**4. ISS-021 regression tests (critical):**
- Multiline error block between adjacent math blocks doesn't merge them
- Create test with:
  ```markdown
  $SEC_{26} := \frac{E_{26}}{T_{26}} = 1$
  $SEC_{27} := \frac{E_{27}}{T_{27}} ==$
  ```
  Process to generate error, then clear - verify blocks remain separate
- Orphan fragments don't appear after clearing

**5. Complex document test:**
- Multiple math blocks with mix of operations
- Verify clear → process → clear is idempotent
- Verify `text[span.start:span.end]` roundtrip

**6. Edge cases:**
- Empty math blocks
- Nested braces in error markup
- Multiple errors on same line
- Multiline math blocks with multiple calculations

Use the actual rendering from the evaluator if needed (process then clear cycle).
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -m pytest tests/test_clear_v2.py -v</verify>
  <done>All tests pass, ISS-021 regression covered</done>
</task>

<task type="auto">
  <name>Task 3: Replace old clear_text with v2 and verify all tests pass</name>
  <files>src/livemathtex/core.py</files>
  <action>
1. **Rename functions:**
   - Rename `clear_text` to `_clear_text_regex` (keep for reference/fallback)
   - Rename `clear_text_v2` to `clear_text`

2. **Update function signature** to match original:
   - Ensure return type is still `tuple[str, int]`
   - Ensure count reflects number of cleared evaluations

3. **Run full test suite:**
   - All 275+ existing tests must pass
   - The new tests from Task 2 must pass
   - Snapshot tests are critical (test_examples.py)

4. **Verify ISS-021 is fixed:**
   - Create reproduction case from issue
   - Process file with bare `=` to generate multiline error
   - Clear file
   - Verify no merged blocks or orphan fragments

5. **If any tests fail:**
   - Debug and fix the new implementation
   - The old regex version remains as `_clear_text_regex` for comparison
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -m pytest -q</verify>
  <done>All tests pass (275+), ISS-021 fixed, old function preserved as fallback</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `clear_text_v2` uses parser from Phase 8/9 (not regex for structure)
- [ ] ISS-021 regression test passes (multiline error doesn't corrupt)
- [ ] Unit hint preservation works (inline and from \text{})
- [ ] Definitions preserved (`:=`, `===`, `=>`)
- [ ] All 275+ existing tests pass
- [ ] New tests in test_clear_v2.py pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-021 fixed (can close issue)
- Document corruption around multiline errors eliminated
- Backward compatible with existing documents
</success_criteria>

<output>
After completion, create `.planning/phases/10-clear-refactor/10-01-SUMMARY.md`
</output>
