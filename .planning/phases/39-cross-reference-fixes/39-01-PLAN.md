---
phase: 39-cross-reference-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/livemathtex/parser/reference_parser.py
  - src/livemathtex/core.py
  - tests/test_cross_references.py
autonomous: true
---

# Phase 39, Plan 01: Fix Cross-Reference Bugs

## Objective

Fix the three cross-reference bugs discovered during v4.1 examples testing:
- ISS-049: `{{var [unit]}}` parsed as array index instead of unit hint
- ISS-050: Variables with subscripts (`η_sys`) and underscores not found
- ISS-051: Output uses SI base units instead of original/readable units

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@src/livemathtex/parser/reference_parser.py
@src/livemathtex/core.py
@examples/cross-references/input.md
@examples/cross-references/output.md

## Tasks

<task name="Fix ISS-049: Unit hint syntax in cross-references" type="auto">
**Files:** `src/livemathtex/parser/reference_parser.py`, `src/livemathtex/core.py`

**Problem:** `{{flow [m³/h]}}` is parsed with ExpressionParser which interprets `[m³/h]` as array indexing.

**Solution:**
1. In `reference_parser.py`, extend the `Reference` dataclass to include an optional `unit_hint` field
2. Modify `extract_references()` to detect and extract `[unit]` syntax BEFORE passing to expression parser
3. Pattern: `{{var [unit]}}` → `Reference(content="var", unit_hint="unit")`
4. In `core.py` `evaluate_cross_references()`:
   - After evaluation, if `ref.unit_hint` is set, convert the result to that unit
   - Use Pint's `.to(unit_hint)` for conversion

**Regex pattern for extraction:**
```python
# Match: {{content [unit_hint]}} or {{content}}
# Content can have nested {} for subscripts
pattern = r'(?<!\\)\{\{((?:[^{}]|\{[^{}]*\})*?)(?:\s*\[([^\]]+)\])?\}\}'
```

**Action:**
1. Add `unit_hint: Optional[str] = None` to Reference dataclass
2. Update regex pattern in `extract_references()` to capture optional `[unit]` suffix
3. Update `evaluate_cross_references()` to apply unit conversion when `ref.unit_hint` is set
4. Handle conversion errors gracefully with error message

**Verify:** Create test with `{{flow [m³/h]}}` syntax, verify conversion works
**Done:** Cross-reference unit hints like `{{flow [m³/h]}}` produce converted output
</task>

<task name="Fix ISS-050: Subscript and underscore variable lookup" type="auto">
**Files:** `src/livemathtex/core.py`

**Problem:** Variables with subscripts (`η_sys`) and escaped underscores (`unit\_cost`) are not found in the symbol table because:
1. The cross-reference content `η_sys` needs to match the normalized latex_name
2. Escaped underscores in source (`unit\_cost`) become `unit_cost` in the ref content

**Root cause analysis:**
- Symbol table stores variables with their `latex_name` (e.g., `\eta_{sys}`, `unit\_cost`)
- Cross-reference content is plain text (e.g., `η_sys`, `unit_cost`)
- Need to normalize both to match

**Solution:**
1. In `evaluate_cross_references()`, before parsing, normalize the reference content:
   - Replace `_` with `_{` and append `}` for subscripts (careful with existing `_{`)
   - Handle Greek letters (η → \eta, etc.)
2. Build symbols_dict with BOTH raw name AND latex_name as keys
3. Add fallback: if direct lookup fails, try variations:
   - Add backslash before underscore: `unit_cost` → `unit\_cost`
   - Wrap subscript content: `P_in` → `P_{in}`

**Action:**
1. Create helper function `normalize_ref_variable(name: str) -> List[str]` that returns possible variations
2. Modify symbol lookup in `evaluate_cross_references()` to try all variations
3. Also add entries for both escaped and unescaped underscore variants to symbols_dict

**Verify:** Test with `{{η_sys}}`, `{{P_in}}`, `{{unit_cost}}` cross-references
**Done:** Variables with subscripts and underscores are found and evaluated correctly
</task>

<task name="Fix ISS-051: Use original units instead of SI base units" type="auto">
**Files:** `src/livemathtex/core.py`

**Problem:** Cross-reference output shows verbose SI base units like `meter ** 2` instead of the original `m²` or at least a readable `kW`.

**Root cause:**
- Line 550: `unit_str = str(result.units)` produces verbose Pint string
- Need to format units using the existing `format_unit_latex()` function

**Solution:**
1. Use `format_unit_latex()` from pint_backend to get clean unit representation
2. If symbol has original unit stored in symbol table, prefer that over evaluated unit
3. For unit conversion cases (ISS-049), use the target unit format

**Action:**
1. After evaluation, check if the symbol has a stored `entry.display_unit` or original unit
2. Use `format_unit_latex(result.units)` instead of `str(result.units)`
3. Strip LaTeX markup (`\text{}`) for cross-reference output since it's in prose

**Verify:** Test `{{P_motor}}` where P_motor := 5.5 kW → output should be "5.5 kW" not "5 500 kilogram * meter ** 2 / second ** 3"
**Done:** Cross-references show human-readable units
</task>

<task name="Add comprehensive tests" type="auto">
**Files:** `tests/test_cross_references.py`

**Action:**
Add test cases for:
1. Unit hint syntax: `{{flow [m³/h]}}` conversion
2. Subscript variables: `{{η_sys}}`, `{{P_{in}}}`
3. Underscore variables: `{{unit_cost}}` vs `unit\_cost`
4. Unit formatting: verify readable output instead of SI base units
5. Combined: `{{P_motor [MW]}}` with subscript AND unit hint

**Verify:** All new tests pass
**Done:** 5+ new tests covering all three bugs
</task>

<task name="Verify cross-references example works" type="auto">
**Files:** `examples/cross-references/input.md`, `examples/cross-references/output.md`

**Action:**
1. Run `livemathtex process examples/cross-references/input.md`
2. Verify output no longer has `{{ERROR: ...}}` messages
3. Verify unit conversions work
4. Verify subscripted variables are found

**Verify:** `examples/cross-references/output.md` has no errors
**Done:** Cross-references example produces clean output with all references evaluated
</task>

## Verification

```bash
# Run full test suite
cd /home/mark/Repositories/livemathtex
source venv/bin/activate
pytest tests/ -v

# Specifically test cross-references
pytest tests/test_cross_references.py -v

# Process the cross-references example
livemathtex process examples/cross-references/input.md -o examples/cross-references/output.md

# Verify no errors in output
grep -c "ERROR" examples/cross-references/output.md
```

## Success Criteria

- [ ] `{{var [unit]}}` syntax works for unit conversion (ISS-049)
- [ ] `{{η_sys}}`, `{{P_in}}`, `{{unit_cost}}` variables are found (ISS-050)
- [ ] Output shows readable units like "kW" not "kilogram * meter ** 2 / second ** 3" (ISS-051)
- [ ] All existing tests pass
- [ ] New tests added for all three bug fixes
- [ ] Cross-references example produces clean output

## Output

On completion, create SUMMARY.md in this directory with:
- Tasks completed
- Bugs fixed (ISS-049, ISS-050, ISS-051)
- Test results
- Any issues encountered
