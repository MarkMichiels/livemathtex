---
phase: 05-fix-recursive-units
type: execute
---

<objective>
Fix ISS-014: Unit conversion fails for recursively defined units (MWh, mol/day, etc.)

Purpose: Enable unit hints like `<!-- [MWh] -->` to display results in the target unit instead of falling back to SI base units (kg·m²/s²).
Output: Working unit conversion for all Pint-recognized units including prefixed and compound units.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (ISS-014 section)

**Key files:**
@src/livemathtex/engine/evaluator.py - `_apply_conversion()` method (line ~1119)
@src/livemathtex/engine/pint_backend.py - `convert_value_to_unit()` function (line ~1331)

**Root cause (from ISS-014):**
`_apply_conversion()` uses SymPy ratio approach:
```python
ratio = value / target_unit
ratio_base = convert_to(ratio, base_units)
numeric_value = float(ratio_base.evalf())  # FAILS - ratio still has units
```

For complex units like MWh (= 1000*kWh = 1000000*Wh), the ratio doesn't simplify to a pure number because SymPy can't cancel the unit expressions properly.

**Solution:**
Use Pint-based conversion via `convert_value_to_unit(value, from_unit, to_unit)` which already exists and handles this correctly.

**Prior decisions:**
- 03-01: Use `pint_to_sympy_with_prefix()` for prefixed units
- 03-01: Raise errors instead of silently failing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add failing tests for recursive unit conversion</name>
  <files>tests/test_unit_conversion.py</files>
  <action>
Create new test file `tests/test_unit_conversion.py` with class `TestRecursiveUnitConversion`:

1. `test_mwh_conversion` - Input: `$E := 168000000000\\ J$\n$E == [MWh]$`
   Expected: result contains `\text{MWh}`, NOT `kg` or `m^2/s^2`

2. `test_mol_per_day_conversion` - Input with mol/day unit hint
   Expected: result contains target unit, not SI base

3. `test_compound_unit_mwh_per_kg` - Input with MWh/kg unit hint
   Expected: result contains target unit

4. `test_prefixed_unit_kwh` - Input: energy in J, convert to kWh
   Expected: correct kWh value

Run tests to verify they FAIL (proving the bug exists).
  </action>
  <verify>pytest tests/test_unit_conversion.py -v shows failures for new tests</verify>
  <done>4 failing tests that reproduce ISS-014</done>
</task>

<task type="auto">
  <name>Task 2: Fix _apply_conversion to use Pint-based conversion</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
Modify `_apply_conversion()` method (~line 1119) to use Pint instead of SymPy ratio:

1. Import `convert_value_to_unit` from pint_backend at top of method
2. Extract numeric value and unit from SymPy expression using `_extract_unit_from_value()`
3. Get unit string for the source unit (format for Pint)
4. Call `convert_value_to_unit(numeric_value, from_unit_str, target_unit_latex)`
5. If Pint conversion succeeds, use that result
6. Keep existing SymPy fallback for edge cases where Pint fails

Key change pattern:
```python
# Extract value and unit from SymPy expression
numeric_val = self._extract_numeric_value(value)
unit_expr, unit_str = self._extract_unit_from_value(value)

# Try Pint-based conversion first (handles MWh, mol/day, etc.)
from .pint_backend import convert_value_to_unit, format_pint_unit
if unit_str:
    pint_result = convert_value_to_unit(numeric_val, unit_str, normalized_unit)
    if pint_result is not None:
        # Success - format result with target unit
        unit_symbol = sympy.Symbol(f'\\text{{{target_unit_latex}}}')
        return pint_result * unit_symbol, ""

# Fallback to existing SymPy approach for edge cases
...
```

Do NOT remove the existing SymPy code - keep as fallback.
  </action>
  <verify>pytest tests/test_unit_conversion.py -v shows all tests passing</verify>
  <done>All 4 new tests pass, MWh/mol·day conversion works</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify no regressions</name>
  <files>tests/</files>
  <action>
1. Run full test suite: `pytest tests/ -v`
2. Verify all ~190 existing tests still pass
3. Check that unit hint tests in test_inline_unit_hints.py still work
4. Check that custom unit tests in test_pint_backend.py still work
5. Run examples to verify real-world documents work:
   - `livemathtex process examples/custom-units/input.md`
   - Check output shows correct unit conversions
  </action>
  <verify>pytest tests/ -v shows all tests passing (190+ tests)</verify>
  <done>Full test suite passes, no regressions, examples work</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/test_unit_conversion.py -v` - All 4 new tests pass
- [ ] `pytest tests/ -v` - Full suite passes (~193+ tests)
- [ ] MWh conversion produces `\text{MWh}` not `kg·m²/s²`
- [ ] mol/day conversion works
- [ ] Existing unit hints (kJ, kW, m/s) still work
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-014 resolved: recursive unit conversion works
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-fix-recursive-units/05-01-SUMMARY.md`
</output>
