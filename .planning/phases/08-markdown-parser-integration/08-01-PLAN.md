---
phase: 08-markdown-parser-integration
plan: 01
type: execute
---

<objective>
Integrate markdown-it-py parser for structural document parsing with accurate source positions.

Purpose: Replace fragile regex-based math block detection with robust markdown parser that properly handles code fences and provides reliable position tracking.
Output: New `parser/markdown_parser.py` module using markdown-it-py + dollarmath_plugin, integrated with existing Lexer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-markdown-parser-integration/08-RESEARCH.md

**Key files:**
@src/livemathtex/parser/lexer.py
@src/livemathtex/parser/models.py

**Research findings:**
- Use markdown-it-py + mdit-py-plugins (dollarmath)
- Token.map provides [line_begin, line_end] (0-indexed)
- Calculate character offsets post-hoc from line positions
- Keep existing calculation parsing unchanged

**Constraints:**
- Don't break existing API (`process_text`, `clear_text`)
- Maintain backward compatibility with existing documents
- Existing `SourceLocation` model should be populated from new parser
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add markdown-it-py dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add dependencies to pyproject.toml:
- `markdown-it-py>=3.0.0`
- `mdit-py-plugins>=0.4.0`

Run `pip install -e .` to install new dependencies and verify import works.
  </action>
  <verify>python -c "from markdown_it import MarkdownIt; from mdit_py_plugins.dollarmath import dollarmath_plugin; print('OK')"</verify>
  <done>Dependencies installed, imports work without error</done>
</task>

<task type="auto">
  <name>Task 2: Create markdown_parser.py module</name>
  <files>src/livemathtex/parser/markdown_parser.py</files>
  <action>
Create new module `parser/markdown_parser.py` with:

1. **MarkdownParser class** that:
   - Initializes markdown-it-py with dollarmath_plugin (`allow_space=True`, `allow_digits=True`)
   - Provides `parse(text: str)` method returning token stream

2. **Position conversion functions:**
   - `build_line_offset_map(text: str) -> List[int]` - cumulative character offset for each line start
   - `line_to_char_offset(text: str, line: int, line_offsets: List[int]) -> int` - convert 0-indexed line to char offset
   - `token_to_source_location(token, text: str, line_offsets: List[int]) -> SourceLocation` - convert Token.map to SourceLocation

3. **Math block extraction:**
   - `extract_math_blocks(text: str) -> List[dict]` that returns list of dicts with:
     - `content`: full match including delimiters
     - `inner_content`: content without delimiters
     - `is_display`: True for `$$`, False for `$`
     - `location`: SourceLocation with accurate line/col
     - `start_offset`, `end_offset`: character positions for precise text replacement

Key implementation notes:
- markdown-it uses 0-indexed lines; current code uses 1-indexed - handle conversion
- Token.map is `[start_line, end_line)` (exclusive end)
- For character offsets, need to handle `\r\n` vs `\n` (normalize to `\n`)
- dollarmath tokens: `math_block` for `$$...$$`, `math_inline` for `$...$`
  </action>
  <verify>
python -c "
from livemathtex.parser.markdown_parser import MarkdownParser, extract_math_blocks
text = '''# Test
\$\$
x := 5
\$\$
'''
blocks = extract_math_blocks(text)
print(f'Found {len(blocks)} blocks')
assert len(blocks) == 1
assert blocks[0]['is_display'] == True
print('OK')
"
  </verify>
  <done>MarkdownParser class exists with parse(), position conversion functions work, extract_math_blocks returns accurate positions</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for position accuracy</name>
  <files>tests/test_markdown_parser.py</files>
  <action>
Create comprehensive tests for the new markdown parser:

1. **Basic math block detection:**
   - Single inline `$x$`
   - Single display `$$x$$`
   - Multiple math blocks in document

2. **Code fence handling:**
   - Math syntax inside code blocks should NOT be extracted
   - Math after code blocks should be extracted correctly

3. **Position accuracy tests:**
   - Verify start_offset points to first `$`
   - Verify end_offset points after last `$`
   - Test multiline math blocks
   - Test `text[start_offset:end_offset] == content`

4. **Edge cases:**
   - Dollar signs in text (not math)
   - Empty math blocks
   - Consecutive math blocks
   - Math at document start/end

Use pytest fixtures for common test documents.
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -m pytest tests/test_markdown_parser.py -v</verify>
  <done>All tests pass, position accuracy verified with round-trip checks</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds
- [ ] `python -c "from livemathtex.parser.markdown_parser import MarkdownParser"` works
- [ ] `python -m pytest tests/test_markdown_parser.py -v` all pass
- [ ] Position accuracy: `text[block['start_offset']:block['end_offset']] == block['content']` for all extracted blocks
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- New module doesn't affect existing functionality
- Position conversion is accurate (verified by round-trip tests)
- Code fences properly excluded from math parsing
</success_criteria>

<output>
After completion, create `.planning/phases/08-markdown-parser-integration/08-01-SUMMARY.md`
</output>
