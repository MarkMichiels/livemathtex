# Plan 37-04: Array Output Formatting and Main Evaluator Integration

## Objective

1. Format array output in LaTeX for display
2. Store arrays properly in the symbol table and IR
3. Handle array definitions in the main evaluator

## Files to Modify

1. `src/livemathtex/engine/evaluator.py` - Array output formatting
2. `tests/test_arrays.md` - End-to-end integration test

## Changes

### 1. Add Array Formatting

Add method to format array values:

```python
def _format_array_latex(self, values: list, config: LivemathConfig) -> str:
    """Format array values as LaTeX."""
    formatted_elements = []
    for val in values:
        if isinstance(val, pint.Quantity):
            formatted_elements.append(self._format_quantity_latex(val, config))
        else:
            formatted_elements.append(str(val))

    # Use compact format for <= 5 elements
    if len(formatted_elements) <= 5:
        return "[" + ", ".join(formatted_elements) + "]"
    else:
        # Use matrix format for longer arrays
        return "\\begin{bmatrix}" + " \\\\ ".join(formatted_elements) + "\\end{bmatrix}"
```

### 2. Update `_compute` to Handle Array Results

Check if result is a list and format appropriately:

```python
# In _compute or result handling:
if isinstance(result, list):
    return self._format_array_latex(result, config)
```

### 3. Store Arrays in Symbol Table

Arrays are stored as lists in the symbol table.

### 4. JSON Storage

Arrays in IR should store:
- type: "array"
- value: list of magnitudes
- unit: common unit string (if all same)
- length: number of elements

## Tests

Create `tests/test_arrays.md`:

```markdown
<!-- livemathtex: output=inplace, json=true, digits=4 -->

# Test: Array Operations

$gamma := [15, 30.5, 34]\ \text{mg/L/d}$
$V_L := 37824\ L$
$m := V_L \cdot gamma == [567.36, 1153.63, 1286.02]\ \text{g/d}$
$first := gamma[0] == 15\ \text{mg/L/d}$
```

## Verification

```bash
livemathtex process tests/test_arrays.md
livemathtex clear tests/test_arrays.md
livemathtex process tests/test_arrays.md  # Verify idempotent
```

## Estimated Time

60-90 minutes
