---
phase: 28-sympy-removal
type: execute
---

<objective>
Complete removal of SymPy and latex2sympy from the codebase.

Purpose: Eliminate root cause of multiple bugs (ISS-035, ISS-036, ISS-037, ISS-038) by removing latex2sympy entirely. The custom v3.0 parser handles everything - no fallback needed.

Output:
- Zero sympy imports in production code
- Zero latex2sympy imports
- Simple internal IDs (v0, v1) instead of LaTeX format (v_{0})
- Packages uninstalled from dependencies
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/ISSUES.md
@src/livemathtex/engine/evaluator.py
@src/livemathtex/engine/expression_evaluator.py
@src/livemathtex/parser/expression_tokenizer.py
@src/livemathtex/parser/expression_parser.py

**Root cause of bugs:**
latex2sympy corrupts its global `var` dict when parsing fails. This corrupted state persists and causes subsequent parses to fail with "Symbol not iterable".

**Solution:**
Remove latex2sympy entirely. The custom parser (v3.0) already works - just remove the fallback path.

**Current state:**
- evaluator.py: 106 sympy references
- pint_backend.py: 148 sympy references
- token_classifier.py: 8 sympy references (can be deleted)
- core.py: 4 sympy references

**Custom parser already handles:**
- Variables with subscripts/superscripts (E_{26}, R^2)
- Multi-letter variables (PPE, Cost)
- Units in \text{} and \mathrm{}
- Fractions (\frac{a}{b})
- All operators (+, -, *, /, ^, \cdot, \times)
- Greek letters (\alpha, \pi, etc.)
- Mathematical constants (pi, e)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove latex2sympy fallback from _compute_with_pint</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
In `_compute_with_pint()` (line ~2522), remove the entire fallback block after the custom parser try/except.

BEFORE:
```python
def _compute_with_pint(self, expression_latex: str) -> 'pint.Quantity':
    # Try custom parser first
    try:
        return self._evaluate_with_custom_parser(expression_latex)
    except (ParseError, CustomEvaluationError) as e:
        logger.debug(f"Custom parser failed..., falling back to latex2sympy: {e}")

    # Fallback: Original latex2sympy path
    # [60+ lines of latex2sympy code]
```

AFTER:
```python
def _compute_with_pint(self, expression_latex: str) -> 'pint.Quantity':
    """Evaluate expression using custom parser and Pint."""
    return self._evaluate_with_custom_parser(expression_latex)
```

Remove ALL the fallback code (the entire block after the except). If custom parser fails, let it fail - we fix the parser, not add fallbacks.
  </action>
  <verify>grep -c "latex2sympy" src/livemathtex/engine/evaluator.py shows reduction</verify>
  <done>No latex2sympy fallback in _compute_with_pint</done>
</task>

<task type="auto">
  <name>Task 2: Remove _compute() function entirely</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
The `_compute()` function (line ~2170) is the OLD latex2sympy-based path. It's ~250 lines of code that's no longer needed.

1. Find all calls to `_compute()` in evaluator.py
2. Replace them with `_compute_with_pint()`
3. Delete the entire `_compute()` function
4. Delete `_rewrite_with_internal_ids()` function (only used by _compute)

Key replacements:
- `self._compute(rhs)` → `self._compute_with_pint(rhs)`
- `self._compute(expression, propagate_units=True)` → `self._compute_with_pint(expression)`

Note: `propagate_units` and `force_units` parameters were for SymPy - Pint handles units automatically.
  </action>
  <verify>grep -n "def _compute\(" src/livemathtex/engine/evaluator.py returns empty</verify>
  <done>_compute() function removed, all calls use _compute_with_pint()</done>
</task>

<task type="auto">
  <name>Task 3: Remove all sympy imports from evaluator.py</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
Remove these imports from the top of evaluator.py:

```python
import sympy
import sympy.physics.units as u
from sympy.parsing.latex import parse_latex

try:
    from latex2sympy2 import latex2sympy
except ImportError:
    def latex2sympy(latex_str):
        ...
```

Also remove:
- `from .token_classifier import TokenClassifier` (will be deleted)
- Any `from sympy...` imports inside functions

Search for and remove ALL occurrences of:
- `import sympy`
- `from sympy`
- `latex2sympy`

Update the Evaluator.__init__ to remove `self.classifier = TokenClassifier(...)`.
  </action>
  <verify>grep -c "sympy\|latex2sympy" src/livemathtex/engine/evaluator.py returns 0</verify>
  <done>Zero sympy imports in evaluator.py</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -r "latex2sympy" src/livemathtex/engine/evaluator.py` returns nothing
- [ ] `grep -c "import sympy" src/livemathtex/engine/evaluator.py` returns 0
- [ ] `python -c "from livemathtex import process_text"` imports successfully
- [ ] `pytest tests/ -x` runs (may have failures - that's for next plan)
</verification>

<success_criteria>
- _compute_with_pint() is the ONLY computation path
- No latex2sympy fallback
- No sympy imports in evaluator.py
- Code compiles and imports work
</success_criteria>

<output>
After completion, create `.planning/phases/28-table-cell-parsing/28-01-SUMMARY.md`

Note: This is Plan 01 of a multi-plan phase. More plans follow:
- 28-02: Remove sympy from pint_backend.py
- 28-03: Remove sympy from other files (core.py, etc.)
- 28-04: Simplify internal IDs (v_{0} → v0)
- 28-05: Delete unused files and uninstall packages
- 28-06: Full test suite verification
</output>
