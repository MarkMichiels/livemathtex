---
phase: 28-sympy-removal
plan: 04
type: execute
---

<objective>
Simplify internal IDs from LaTeX format to plain Python format.

Purpose: The `v_{0}` format was for latex2sympy compatibility. Now we can use simple `v0`, `v1`, `f0` format.

Output: All internal IDs use simple format (v0, v1, f0) - no LaTeX braces
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/livemathtex/engine/symbols.py
@src/livemathtex/engine/evaluator.py

**Depends on:** 28-03 complete

**Current format:**
- Variables: `v_{0}`, `v_{1}`, `v_{2}`, ...
- Functions: `f_{0}`, `f_{1}`, `f_{2}`, ...

**New format:**
- Variables: `v0`, `v1`, `v2`, ...
- Functions: `f0`, `f1`, `f2`, ...

**Files that use internal IDs:**
- symbols.py: NameGenerator creates the IDs
- evaluator.py: Uses IDs in symbol lookups
- ir/schema.py: Stores internal_id field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NameGenerator in symbols.py</name>
  <files>src/livemathtex/engine/symbols.py</files>
  <action>
Find the NameGenerator class (or equivalent) that generates internal IDs.

Change the format from LaTeX-style to simple:

BEFORE:
```python
internal_id = f"v_{{{self._var_counter}}}"  # v_{0}, v_{1}
func_id = f"f_{{{self._func_counter}}}"     # f_{0}, f_{1}
```

AFTER:
```python
internal_id = f"v{self._var_counter}"  # v0, v1
func_id = f"f{self._func_counter}"     # f0, f1
```

Update any regex patterns that match internal IDs:
- `r'v_\{(\d+)\}'` → `r'v(\d+)'`
- `r'f_\{(\d+)\}'` → `r'f(\d+)'`
  </action>
  <verify>python -c "from livemathtex.engine.symbols import SymbolTable; s = SymbolTable(); print(s)" works</verify>
  <done>NameGenerator produces simple IDs (v0, v1)</done>
</task>

<task type="auto">
  <name>Task 2: Update internal ID matching in evaluator.py</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
Search for all regex patterns and string operations that work with internal IDs.

Update patterns:
- `r'^v_\{?(\d+)\}?$'` → `r'^v(\d+)$'`
- `f"v_{{{digit}}}"` → `f"v{digit}"`
- Similar for function IDs

Key locations (after 28-01/02/03 cleanup):
- _evaluate_with_custom_parser: builds symbol_map with internal IDs
- Any lookup functions that match internal IDs
  </action>
  <verify>grep -n "v_{\|f_{" src/livemathtex/engine/evaluator.py returns nothing</verify>
  <done>All internal ID patterns use simple format</done>
</task>

<task type="auto">
  <name>Task 3: Update expression_evaluator.py variable lookup</name>
  <files>src/livemathtex/engine/expression_evaluator.py</files>
  <action>
Check `_lookup_variable()` function for any LaTeX-specific handling.

The function currently handles:
- Exact match
- Normalized (remove braces)
- Add braces if has underscore

Update to handle simple format:
- Exact match (v0, v1)
- Original LaTeX names (E_{26}, PPE_{eff})
- Normalized versions

Remove any brace-adding logic for internal IDs since they won't have braces anymore.
  </action>
  <verify>python -c "from livemathtex.engine.expression_evaluator import evaluate_expression_tree; print('OK')"</verify>
  <done>Variable lookup handles simple internal IDs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -rn "v_{" src/livemathtex/` returns only LaTeX display code, not internal IDs
- [ ] Internal IDs generated as v0, v1, v2 (not v_{0})
- [ ] Symbol lookups work with new format
</verification>

<success_criteria>
- All internal IDs use simple format
- No LaTeX braces in internal representations
- Symbol table and evaluator work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/28-table-cell-parsing/28-04-SUMMARY.md`
</output>
