---
phase: 28-sympy-removal
plan: 06
type: execute
---

<objective>
Full test suite verification and bug fixes.

Purpose: Ensure the Pure Pint architecture works for ALL cases. Fix any test failures by extending the custom parser, NOT by adding sympy back.

Output: All 528+ tests pass, real documents process correctly
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ISSUES.md
@tests/

**Depends on:** 28-05 complete (all sympy removed)

**Test files:**
- tests/test_iss_035_symbol_not_iterable_in_tables.md
- tests/test_iss_037_table_cell_symbol_not_iterable.md
- tests/test_iss_036_comma_subscript_symbol_not_iterable.md
- tests/test_iss_038_comma_subscript_expression_parse_error.md

**Real-world validation:**
- mark-private/private/axabio_confidential/business/abp_2026_2030/docs/astaxanthin_production_analysis.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite</name>
  <files>tests/</files>
  <action>
Run the complete test suite:

```bash
pytest tests/ -v --tb=short 2>&1 | head -200
```

Collect ALL failures - don't stop at first failure.

For each failure:
- Identify what the test is testing
- Determine if it's testing sympy-specific behavior (delete test) or actual functionality (fix)
  </action>
  <verify>pytest tests/ -v runs to completion</verify>
  <done>Test suite runs, failures identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix custom parser for any missing functionality</name>
  <files>src/livemathtex/parser/expression_tokenizer.py, src/livemathtex/parser/expression_parser.py, src/livemathtex/engine/expression_evaluator.py</files>
  <action>
For each test failure that requires functionality the custom parser doesn't have:

1. Identify what's missing (e.g., \ln, \sqrt, \sin)
2. Add to expression_tokenizer.py:
   - New TokenType if needed
   - New pattern in PATTERNS list
3. Add to expression_parser.py:
   - Handle new token type in parsing
4. Add to expression_evaluator.py:
   - Evaluate the new construct

DO NOT add sympy fallback. Extend the custom parser instead.

Common missing features to check:
- Math functions: \ln, \log, \sqrt, \sin, \cos, \tan
- Absolute value: |x| or \abs{x}
- Square root: \sqrt{x}
  </action>
  <verify>pytest tests/ -v shows fewer failures</verify>
  <done>Custom parser handles all required constructs</done>
</task>

<task type="auto">
  <name>Task 3: Delete or update sympy-specific tests</name>
  <files>tests/</files>
  <action>
Some tests may be testing sympy-specific behavior that's no longer relevant.

For each remaining test failure:
- If test is about sympy internals: DELETE the test
- If test is about implicit multiplication detection: DELETE (token_classifier gone)
- If test is about actual calculation behavior: FIX the code

Update any test that imports sympy directly.
  </action>
  <verify>pytest tests/ -v | grep -c "FAILED" returns 0</verify>
  <done>All tests pass or are deleted with justification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete SymPy removal with Pure Pint architecture</what-built>
  <how-to-verify>
    1. Run: cd /home/mark/Repositories/livemathtex && pytest tests/ -v
    2. Confirm: All tests pass (or only expected xfails)
    3. Run: livemathtex process tests/test_iss_037_table_cell_symbol_not_iterable.md
    4. Confirm: No "Symbol not iterable" errors
    5. Run: livemathtex process [path to astaxanthin doc]
    6. Confirm: Processes without sympy errors
  </how-to-verify>
  <resume-signal>Type "approved" if all works, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/` passes all tests
- [ ] ISS-035, ISS-036, ISS-037, ISS-038 test files process without errors
- [ ] Real production document processes correctly
- [ ] `pip show sympy` returns "not installed"
- [ ] `pip show latex2sympy2` returns "not installed"
</verification>

<success_criteria>
- All 528+ tests pass
- ISS-035, ISS-036, ISS-037, ISS-038 are FIXED
- Real documents work
- Zero sympy anywhere
- Package size reduced significantly
</success_criteria>

<output>
After completion, create `.planning/phases/28-table-cell-parsing/28-06-SUMMARY.md`

Update ISSUES.md:
- Close ISS-035, ISS-036, ISS-037, ISS-038 with "Fixed by complete SymPy removal"

Update ROADMAP.md:
- Mark Phase 28 complete
- Update milestone v3.1 status
</output>
