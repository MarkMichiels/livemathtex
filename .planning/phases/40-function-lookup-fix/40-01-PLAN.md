---
phase: 40-function-lookup-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/livemathtex/engine/evaluator.py
  - tests/test_functions.py
autonomous: true
---

# Phase 40, Plan 01: Fix Function Lookup Bug

## Objective

Fix ISS-048: Function call lookup fails with multiple user-defined functions due to incorrect internal ID concatenation.

## Context

@.planning/PROJECT.md
@.planning/ISSUES.md
@src/livemathtex/engine/evaluator.py
@examples/functions/input.md

## Problem Analysis

When multiple functions are defined:
```latex
$f(x) := x^2$           % assigned internal_id f0
$PPE_{eff}(r) := r * 4.29$  % assigned internal_id f1
$result := PPE_{eff}(0.70) ==$  % looks for f01 instead of f1
```

The issue is that the function lookup concatenates indices incorrectly. Need to trace:
1. How functions are registered in the symbol table
2. How function calls are resolved
3. Where the incorrect ID concatenation occurs

## Tasks

<task name="Locate function lookup bug" type="auto">
**Files:** `src/livemathtex/engine/evaluator.py`

**Action:**
1. Search for where function internal_id is generated during definition
2. Search for where function calls are resolved
3. Identify the string concatenation error

**Verify:** Find the exact line(s) causing the bug
</task>

<task name="Fix function ID lookup" type="auto">
**Files:** `src/livemathtex/engine/evaluator.py`

**Action:**
1. Fix the function ID lookup/concatenation logic
2. Ensure function calls correctly match to their definitions
3. Handle edge cases (multiple functions, similar names)

**Verify:** Function lookup returns correct function for each call
</task>

<task name="Add regression tests" type="auto">
**Files:** `tests/test_functions.py`

**Action:**
Add test cases for:
1. Multiple functions in same document
2. Function with similar name prefixes
3. Calling each function independently

**Verify:** All tests pass
</task>

<task name="Verify functions example works" type="auto">
**Files:** `examples/functions/input.md`

**Action:**
1. Process the functions example
2. Verify no errors in output
3. Check function evaluations are correct

**Verify:** Example produces correct output
</task>

## Verification

```bash
cd /home/mark/Repositories/livemathtex
source .venv/bin/activate
pytest tests/ -v -k "function"

# Process the functions example
livemathtex process examples/functions/input.md
```

## Success Criteria

- [ ] Multiple functions can be defined in same document
- [ ] Each function call resolves to correct definition
- [ ] All existing tests pass
- [ ] Functions example produces correct output

## Output

On completion, create SUMMARY.md in this directory.
