---
phase: 20-umol-json-fix
plan: 01
type: execute
---

<objective>
Fix µmol/micromol JSON serialization bug where prefix units lose their magnitude factor during storage.

Purpose: When computing expressions like `PPE_{red} * f_{geom}` where `PPE_{red}` has unit `µmol/J`, the stored value incorrectly uses the unscaled magnitude (e.g., 3.9223 instead of 3.9223e-06) while the unit shows the base unit without prefix (mol·s²/kg·m²). This causes 1,000,000x calculation errors when the value is used in subsequent calculations.

Output:
- Fixed `_handle_assignment_evaluation()` to correctly store values with prefix magnitudes
- Test case proving µmol calculations chain correctly
- ISS-030 resolved
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (see ISS-030 for full bug description)

Source files:
@src/livemathtex/engine/evaluator.py (main fix location)
@src/livemathtex/engine/pint_backend.py (helpers for Pint evaluation)

Test file:
@tests/test_iss_030_inplace_update.md (reproduces bug)
@tests/test_iss_030_inplace_update.lmt.json (shows incorrect JSON output)

**Root cause analysis:**

1. In `_handle_assignment_evaluation()` (lines 864-953), when computing `PPE_{eff} := PPE_{red} * f_{geom}`:
   - `_compute(rhs, propagate_units=True)` returns a SymPy expression
   - SymPy internally represents `µmol/J` as `1e-6 * mol/J` (prefix expanded)
   - `_extract_unit_from_value(value)` extracts `mol·s²/(kg·m²)` WITHOUT the 1e-6 factor
   - The numeric value (3.9223) is stored directly without the 1e-6 scaling

2. When `PAR_{rct} := P_{LED,dc} * PPE_{eff}` uses the stored value:
   - It retrieves value=3.9223 with unit `mol·s²/(kg·m²)` (should be 3.9223e-06)
   - Calculation produces 7530.9 mol/s instead of 7530.9 µmol/s = 0.0075309 mol/s
   - Target unit conversion to mol/d gives 650,670,299 mol/d instead of 650.6 mol/d

**Fix strategy:**
Use Pint evaluation (already used for display) to get correct value+unit for storage.
The `_compute_with_pint()` method correctly handles prefix magnitudes.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix value storage in _handle_assignment_evaluation</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
Modify `_handle_assignment_evaluation()` to use Pint for computing storage values instead of SymPy.

Current code (lines ~929-932) already uses Pint for display formatting:
```python
try:
    pint_result = self._compute_with_pint(rhs)
    result_latex = self._format_pint_result(pint_result, calc.unit_comment, cfg)
```

Move the Pint evaluation BEFORE the storage call, and use the Pint result to determine:
- `original_value`: magnitude from `pint_result.magnitude`
- `original_unit`: unit from `pint_result.units` formatted properly
- `si_value` and `si_unit`: from `pint_result.to_base_units()`

Key changes:
1. Move `pint_result = self._compute_with_pint(rhs)` earlier (before line 917's `self.symbols.set()`)
2. Extract values from Pint result:
   - `original_value = float(pint_result.magnitude)`
   - `original_unit = format_pint_unit(pint_result.units)` or similar
   - `base_result = pint_result.to_base_units()`
   - `si_value = float(base_result.magnitude)`
   - `si_unit_str = format_pint_unit(base_result.units)`
3. Keep SymPy fallback for edge cases where Pint evaluation fails

AVOID:
- Breaking existing SymPy-based storage for dimensionless values (keep fallback)
- Removing the display formatting code (that still uses Pint and works correctly)
- Changing the IR schema structure (keep existing fields)
  </action>
  <verify>Run test: `pytest tests/test_pint_evaluator.py -v` - all 15 tests should pass</verify>
  <done>Pint evaluation used for storage values, no test failures</done>
</task>

<task type="auto">
  <name>Task 2: Create regression test for µmol calculation chain</name>
  <files>tests/test_pint_evaluator.py</files>
  <action>
Add test case that verifies:
1. `PPE_{red} := 4.29 µmol/J` stores correctly (value ~4.29e-06 in base units)
2. `PPE_{eff} := PPE_{red} * 0.9143` stores correctly (value ~3.9223e-06)
3. `PAR := 1920 W * PPE_{eff}` evaluates to ~0.0075309 mol/s (not 7530.9 mol/s)
4. Conversion to mol/d gives ~650.6 mol/d (not 650,670,299 mol/d)

Test should:
- Process a minimal markdown document with the calculation chain
- Verify JSON output has correct magnitudes
- Verify final evaluation gives correct result
  </action>
  <verify>Run `pytest tests/test_pint_evaluator.py::test_micromol_chain -v` - test passes</verify>
  <done>Regression test exists and passes, demonstrating fix works</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and close ISS-030</name>
  <files>.planning/ISSUES.md</files>
  <action>
1. Run full test suite: `pytest tests/ -v`
2. Verify all 365+ tests pass
3. Move ISS-030 from "## Open Enhancements" to "## Closed Issues" in ISSUES.md
4. Add resolution note explaining the fix (Pint used for storage values, not just display)
  </action>
  <verify>pytest tests/ shows all tests passing</verify>
  <done>All tests pass, ISS-030 moved to closed with resolution</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/ -v` all tests pass (365+)
- [ ] `tests/test_iss_030_inplace_update.md` produces correct JSON (values have correct magnitude)
- [ ] Calculation chain gives ~650.6 mol/d (not 650,670,299 mol/d)
- [ ] ISS-030 closed in ISSUES.md
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- µmol calculation chains produce correct results
- No regression in existing tests
- ISS-030 resolved
</success_criteria>

<output>
After completion, create `.planning/phases/20-umol-json-fix/20-01-SUMMARY.md`

# Phase 20 Plan 1: Fix µmol JSON Serialization Summary

**Fixed prefix unit magnitude storage by using Pint for storage values**

## Accomplishments

- Fixed `_handle_assignment_evaluation()` to use Pint for value storage
- Regression test verifies µmol→mol calculation chains work correctly
- ISS-030 closed

## Files Created/Modified

- `src/livemathtex/engine/evaluator.py` - Use Pint for storage values
- `tests/test_pint_evaluator.py` - Regression test for µmol chains

## Decisions Made

[Document key decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 20 complete, milestone v1.9 ready for release
</output>
