# Plan 21-01: Fix Function Call Evaluation (ISS-032)

## Objective

Fix function evaluation so user-defined functions can be called with arguments.

## Root Cause Analysis

**Two interrelated issues:**

1. **Multi-letter function names parsed as multiplication**
   - `PPE_{eff}(0.90)` → `P*P*E...` (latex2sympy limitation)
   - Single-letter functions work: `f_{eff}(0.90)` → `f_{eff}(9/10)` ✓

2. **`E` in subscripts causes parse errors**
   - `f_{PPE}(0.90)` fails because `E` is treated specially by latex2sympy
   - This is a latex2sympy quirk with Euler's number

## Solution

**Preprocess expressions before latex2sympy to convert known function calls to safe format.**

### Implementation Steps

1. **Add `_preprocess_function_calls()` method** in `evaluator.py`:
   - Scan for known function names from symbol table
   - Use regex to find `func_name(args)` patterns
   - Replace with internal ID format that latex2sympy can parse: `__f_{N}__`

2. **Add `_restore_function_names()` helper** or handle during substitution:
   - After latex2sympy parsing, map internal IDs back to actual functions
   - Or: Store mapping and use during `_substitute_symbols`

3. **Modify `_compute()` method**:
   - Call `_preprocess_function_calls()` before `latex2sympy()`
   - Ensure function substitution works with preprocessed names

4. **Update `_substitute_symbols()`** if needed:
   - Ensure internal function IDs are mapped to Lambda objects

5. **Add tests** for function calls:
   - Simple function: `f(x) := x * 2`, `f(5) == 10`
   - Multi-letter function: `PPE_{eff}(r) := r * 4.29`, `PPE_{eff}(0.9)`
   - Function with E in name: `E_{total}(x)` (if possible)

## Files to Modify

- `src/livemathtex/engine/evaluator.py`:
  - Add `_preprocess_function_calls()` method (~line 2168, before `_compute`)
  - Modify `_compute()` to call preprocessor
  - May need to update `_substitute_symbols()` for internal ID mapping

## Test Cases

1. **Basic function call**: `f(x) := 2*x`, `f(5) == 10`
2. **Multi-letter function**: `PPE_{eff}(r) := r*4.29`, `PPE_{eff}(0.9) == 3.861`
3. **Function with subscript and E**: `E_{tot}(x) := x+1` (verify workaround)
4. **Function in larger expression**: `y := f(3) + 2`
5. **Nested (if supported)**: `f(g(2))`

## Acceptance Criteria

- [ ] `tests/test_iss_032_function_evaluation.md` processes without errors
- [ ] Function calls evaluate to correct numeric values
- [ ] All 365+ existing tests still pass
- [ ] Multi-letter function names work (PPE, ABC, etc.)
