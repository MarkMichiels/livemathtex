# Phase 25 Plan 01: Direct Pint Evaluator

<objective>
Implement expression tree evaluation using Pint directly, without any SymPy involvement. This creates the new evaluation path that will replace evaluate_sympy_ast_with_pint().
</objective>

<execution_context>
@src/livemathtex/parser/expression_parser.py - ExprNode hierarchy (Phase 24)
@src/livemathtex/engine/pint_backend.py - Existing Pint utilities, evaluate_sympy_ast_with_pint pattern
@.planning/phases/23-remove-latex2sympy/23-RESEARCH.md - Architecture patterns
</execution_context>

<context>
## Background

Phases 23-24 created:
- ExpressionTokenizer: LaTeX → typed tokens
- ExpressionParser: tokens → expression tree (ExprNode)

Now we need an evaluator that:
- Takes ExprNode tree
- Looks up variables in symbol table (as Pint Quantities)
- Performs arithmetic with proper unit handling
- Returns Pint Quantity result

## Key Requirements

1. **Node evaluation:**
   - NumberNode → Pint Quantity (dimensionless)
   - VariableNode → lookup in symbol table
   - BinaryOpNode → evaluate operands, apply operator
   - UnaryOpNode → evaluate operand, negate
   - FracNode → division
   - UnitAttachNode → multiply by unit

2. **Variable name mapping:**
   - Parser preserves LaTeX names (E_{26}, \alpha)
   - Symbol table may have different keys
   - Need name normalization for lookup

3. **Unit handling:**
   - Use existing Pint registry (get_unit_registry())
   - UnitAttachNode applies unit: `5 \text{kg}` → 5 * ureg.kg
   - Dimensionless numbers: `5` → 5 * ureg.dimensionless

4. **Error handling:**
   - Undefined variable → clear error message
   - Unit mismatch → let Pint raise DimensionalityError
   - Division by zero → handle gracefully

## TDD Approach

Same pattern as Phases 23-24:
- RED: Create test file first
- GREEN: Implement evaluator
- REFACTOR: Clean up if needed
</context>

<tasks>
## RED Phase - Write Failing Tests

### Task 1: Create test file structure
Create `tests/test_expression_evaluator.py` with imports.

### Task 2: Test number evaluation
- `5` → 5.0 * dimensionless
- `3.14` → 3.14 * dimensionless
- `1e6` → 1000000.0 * dimensionless

### Task 3: Test variable lookup
- `x` with x=5 → 5.0
- `m` with m=10*kg → 10 kg
- Undefined variable → EvaluationError

### Task 4: Test binary operations
- Addition: `a + b` with quantities
- Subtraction: `a - b`
- Multiplication: `a * b` (including unit multiplication)
- Division: `a / b`
- Power: `a ^ 2` (exponent must be dimensionless)

### Task 5: Test unit attachment
- `5 \text{kg}` → 5 kg
- `100 \text{MWh}` → 100 MWh
- `10 \text{kg/m^3}` → 10 kg/m³

### Task 6: Test fractions
- `\frac{1}{2}` → 0.5
- `\frac{a}{b}` → a / b

### Task 7: Test unary minus
- `-5` → -5.0
- `-x` → -x

### Task 8: Test complex expressions
- `\frac{1}{2} \cdot m` → 0.5 * m
- `a + b * c` → a + (b * c)
- Rate calculations with units

### Task 9: Test dimension checking
- `5 \text{kg} + 3 \text{m}` → DimensionalityError

### Task 10: Run tests - verify all fail
Commit: `test(25-01): add failing tests for expression evaluator`

## GREEN Phase - Implement Evaluator

### Task 11: Create expression_evaluator.py module
Create `src/livemathtex/engine/expression_evaluator.py` with:
- `evaluate_expression_tree()` function
- `EvaluationError` exception

### Task 12: Implement node evaluation
- Handle each ExprNode type
- Use pattern matching or isinstance checks

### Task 13: Implement variable lookup
- Normalize LaTeX names for lookup
- Support multiple key formats (E_{26}, E_26)

### Task 14: Implement unit attachment
- Parse unit string with Pint
- Handle compound units

### Task 15: Run tests - verify all pass
Commit: `feat(25-01): implement expression tree evaluator`

## REFACTOR Phase

### Task 16: Code review
- Check alignment with pint_backend patterns
- Ensure consistent error messages

### Task 17: Create SUMMARY.md
</tasks>

<verification>
## Verification Steps

1. Run new tests: `pytest tests/test_expression_evaluator.py -v`
2. Run full suite: `pytest tests/ -v`
3. Manual integration test:
   ```python
   from livemathtex.parser.expression_tokenizer import ExpressionTokenizer
   from livemathtex.parser.expression_parser import ExpressionParser
   from livemathtex.engine.expression_evaluator import evaluate_expression_tree
   from livemathtex.engine.pint_backend import get_unit_registry

   ureg = get_unit_registry()
   symbols = {'m': 10 * ureg.kg, 'v': 5 * ureg('m/s')}

   tokens = ExpressionTokenizer(r"m \cdot v").tokenize()
   tree = ExpressionParser(tokens).parse()
   result = evaluate_expression_tree(tree, symbols)
   print(result)  # Should be 50 kg⋅m/s
   ```
</verification>

<success_criteria>
- [ ] evaluate_expression_tree() handles all ExprNode types
- [ ] Variable lookup with name normalization
- [ ] Unit attachment via UnitAttachNode
- [ ] Proper error handling (undefined vars, dimension mismatch)
- [ ] All new tests pass
- [ ] All existing 480+ tests still pass
- [ ] TDD commits (RED, GREEN) made
</success_criteria>

<output>
## Expected Output

Files created:
- `src/livemathtex/engine/expression_evaluator.py` - Evaluator module
- `tests/test_expression_evaluator.py` - Tests
- `.planning/phases/25-direct-pint-evaluator/25-01-SUMMARY.md`

Commits:
1. `test(25-01): add failing tests for expression evaluator`
2. `feat(25-01): implement expression tree evaluator`
</output>
