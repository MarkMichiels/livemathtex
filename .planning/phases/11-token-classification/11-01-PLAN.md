---
phase: 11-token-classification
plan: 01
type: execute
---

<objective>
Improve multi-letter identifier handling with better diagnostics for implicit multiplication detection.

Purpose: Fix ISS-018 and ISS-022 - when `latex2sympy` interprets multi-letter identifiers (like `PPE`, `PAR`) as implicit multiplication, provide clear error messages mentioning the intended symbol instead of the single-letter split.
Output: Improved error messages, centralized token classification, regression tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structural-math-parsing/09-01-SUMMARY.md
@.planning/phases/10-clear-refactor/10-01-SUMMARY.md

**Key files:**
@src/livemathtex/engine/evaluator.py (current _check_undefined_symbols implementation)
@src/livemathtex/engine/pint_backend.py (is_unit_token, is_known_unit functions)

**Tech available from prior phases:**
- `extract_math_blocks()` → List[ParsedMathBlock] with doc_start_offset, doc_end_offset
- `parse_math_block_calculations()` → List[ParsedCalculation] with operation, result_span
- `is_unit_token()` and `is_known_unit()` functions for unit detection
- Symbol table with `get_all_latex_to_internal()` for known variables

**Issues being addressed:**
- ISS-018: Implicit multiplication of multi-letter identifiers causes misleading unit/variable errors
- ISS-022: Improve diagnostics when multi-letter identifiers are split

**Current behavior (problem):**
- `$x := PPE$` (PPE not defined) → `latex2sympy` parses as `P*P*E` → Error: "Undefined variable 'P'"
- `$x := PAR$` (PAR not defined) → `latex2sympy` parses as `P*A*R` → Error: "Undefined variable 'A' (A is also a unit: ampere)"
- User has no idea the issue is `PPE` or `PAR`

**Expected behavior:**
- `$x := PPE$` → Error: "Undefined variable 'PPE'. Note: 'PPE' was parsed as implicit multiplication (P*P*E). Define '$PPE := ...$' before use, or use a structured name like 'PPE_{...}'."
- Same for `PAR`, with additional hint about `A` being ampere

**Constraints:**
- Must preserve existing behavior for correctly defined symbols
- Must not break existing 302 tests
- Should centralize token classification logic in one place
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create token_classifier module with multi-letter detection</name>
  <files>src/livemathtex/engine/token_classifier.py</files>
  <action>
Create new module that centralizes token classification logic:

1. **Create `TokenClassifier` class:**
   ```python
   class TokenClassifier:
       """Centralized token classification for variables, units, and functions."""

       def __init__(self, symbol_table: SymbolTable, pint_backend):
           self.symbols = symbol_table
           self.pint = pint_backend

       def classify(self, token: str) -> TokenType:
           """Classify a token as UNIT, VARIABLE, FUNCTION, or UNKNOWN."""
           ...

       def is_multi_letter_identifier(self, token: str) -> bool:
           """Check if token looks like a multi-letter identifier (PPE, PAR, etc.)."""
           ...

       def detect_implicit_multiplication(self, original_latex: str, parsed_symbols: Set[Symbol]) -> Optional[ImplicitMultInfo]:
           """Detect if a multi-letter identifier was split by latex2sympy.

           Returns info about the detected pattern if found, None otherwise.
           """
           ...
   ```

2. **Create `TokenType` enum:** UNIT, VARIABLE, FUNCTION, UNKNOWN

3. **Create `ImplicitMultInfo` dataclass:**
   - `intended_symbol`: str (e.g., "PPE")
   - `split_as`: str (e.g., "P*P*E")
   - `undefined_letters`: List[str] (e.g., ["P", "E"])
   - `unit_conflicts`: List[str] (e.g., ["A"] for ampere)

4. **Implement `detect_implicit_multiplication()`:**
   - Scan original_latex for contiguous multi-letter sequences (uppercase like `PPE`, or mixed like `PAR`)
   - Check if the sequence matches the pattern of single-letter symbols in `parsed_symbols`
   - Return `ImplicitMultInfo` if match found

5. **Move `is_unit_token` and `is_known_unit` usage through classifier:**
   - Classifier wraps these functions for consistent interface
   - Add `has_unit_conflict(letter: str) -> Optional[str]` to detect unit name collisions
  </action>
  <verify>python -c "from livemathtex.engine.token_classifier import TokenClassifier, TokenType, ImplicitMultInfo; print('OK')"</verify>
  <done>TokenClassifier importable, TokenType and ImplicitMultInfo dataclasses defined, detect_implicit_multiplication() implemented</done>
</task>

<task type="auto">
  <name>Task 2: Integrate classifier into evaluator with improved error messages</name>
  <files>src/livemathtex/engine/evaluator.py</files>
  <action>
Modify `_check_undefined_symbols()` to use the new TokenClassifier:

1. **Add TokenClassifier instance to Evaluator.__init__():**
   - Create classifier when evaluator is initialized
   - Pass symbol_table and pint_backend

2. **Update `_check_undefined_symbols()`:**
   ```python
   def _check_undefined_symbols(self, value: Any, original_latex: str) -> None:
       # ... existing logic to find undefined symbols ...

       # NEW: Check for implicit multiplication pattern
       if undefined:
           impl_info = self.classifier.detect_implicit_multiplication(
               original_latex, value.free_symbols
           )

           if impl_info:
               # Generate specialized error message
               msg = f"Undefined variable '{impl_info.intended_symbol}'."
               msg += f" Note: '{impl_info.intended_symbol}' was parsed as implicit multiplication ({impl_info.split_as})."
               msg += f" Define '${impl_info.intended_symbol} := ...$' before use, or use a structured name like '{impl_info.intended_symbol}_{{...}}'."

               if impl_info.unit_conflicts:
                   conflicts = ', '.join(f"'{u}'" for u in impl_info.unit_conflicts)
                   msg += f" (Letter(s) {conflicts} conflict with unit names)"

               raise EvaluationError(msg)

           # ... existing generic error message fallback ...
   ```

3. **Preserve backward compatibility:**
   - If no implicit multiplication detected, use existing error messages
   - Don't change behavior for correctly-defined symbols
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -c "
from livemathtex.core import process_text
result, ir = process_text('\$x := PPE\$')
print('Test passed - should have error about PPE')
" 2>&1 | grep -i "PPE"</verify>
  <done>Error message for `$x := PPE$` mentions 'PPE' and explains implicit multiplication</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for implicit multiplication detection</name>
  <files>tests/test_token_classifier.py</files>
  <action>
Create comprehensive test file:

**1. TokenClassifier tests:**
- `test_classify_known_unit()` - kg, MWh, mol are UNIT
- `test_classify_known_variable()` - defined symbols are VARIABLE
- `test_classify_unknown()` - undefined single letters are UNKNOWN
- `test_is_multi_letter_identifier()` - PPE, PAR, ABC are multi-letter; x, A are not

**2. Implicit multiplication detection tests:**
- `test_detect_ppe_as_implicit_mult()` - PPE → P*P*E detected
- `test_detect_par_with_ampere_conflict()` - PAR → P*A*R detected, A flagged as unit conflict
- `test_no_detection_for_defined_symbol()` - PPE defined → no detection
- `test_no_detection_for_single_letters()` - `$x := a$` → no spurious detection

**3. End-to-end error message tests:**
- `test_error_message_mentions_ppe()` - processing `$x := PPE$` error contains 'PPE'
- `test_error_message_mentions_implicit_mult()` - error mentions "implicit multiplication"
- `test_error_message_shows_split()` - error shows "P*P*E" or similar
- `test_ampere_conflict_mentioned()` - PAR error mentions ampere

**4. Regression tests (existing behavior preserved):**
- `test_defined_ppe_works()` - `$PPE := 1$\n$x := PPE$` evaluates correctly
- `test_subscript_syntax_works()` - `$PPE_{eff} := 1$` works as before
- `test_single_letter_undefined()` - `$x := a$` still shows "Undefined variable 'a'"
  </action>
  <verify>cd /home/mark/Repositories/livemathtex && python -m pytest tests/test_token_classifier.py -v</verify>
  <done>All token classifier tests pass, existing behavior preserved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `from livemathtex.engine.token_classifier import TokenClassifier` works
- [ ] `$x := PPE$` error mentions 'PPE' and 'implicit multiplication'
- [ ] `$x := PAR$` error mentions 'PAR' and 'ampere' conflict
- [ ] `$PPE := 1$\n$x := PPE$` works correctly (existing behavior)
- [ ] All 302+ existing tests still pass
- [ ] New tests in test_token_classifier.py pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-018 improved: error messages now mention the multi-letter identifier
- ISS-022 addressed: diagnostics explain implicit multiplication pattern
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/11-token-classification/11-01-SUMMARY.md`
</output>
