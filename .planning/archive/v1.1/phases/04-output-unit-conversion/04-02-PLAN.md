---
phase: 04-output-unit-conversion
plan: 02
type: execute
---

<objective>
Implement inline unit hint syntax `$E == [MWh]$` (ISS-008).

Purpose: Provide a cleaner, more visible alternative to HTML comment syntax for specifying output units.
Output: Parser and evaluator support for inline `[unit]` syntax in evaluations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (ISS-008)
@.planning/phases/04-output-unit-conversion/04-01-SUMMARY.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Current implementation
@src/livemathtex/parser/lexer.py
@src/livemathtex/engine/evaluator.py

**From ISSUES.md ISS-008:**
- Current syntax: `$E ==$ <!-- [MWh] -->` (verbose, invisible in rendered Markdown)
- Proposed syntax: `$E == [MWh]$` (inline, visible, cleaner)
- Parser should detect `[unit]` at end of evaluation and extract as unit_comment
- Result should replace `[unit]` with converted value

**Implementation strategy:**
1. Modify lexer to detect `== ... [unit]$` pattern
2. Extract unit from brackets into `unit_comment` field
3. Evaluator already handles `unit_comment` via `_apply_conversion()`
4. Output should show `$E == 1000\ \text{MWh}$` (unit replaces bracket)

**Patterns from prior phases:**
- LaTeX cleaning in pint_backend.py (02-02)
- Unit comment parsing in lexer.py (existing)
- Atomic commits per task
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inline unit hint parsing to lexer</name>
  <files>src/livemathtex/parser/lexer.py</files>
  <action>
Modify the calculation extraction logic to detect inline unit hints:

1. In `extract_calculations()`, when processing evaluations (`==`):
   - Check if the content after `==` ends with `[unit]` pattern
   - Regex: `\[([^\]]+)\]\s*$` to match `[unit]` at end
   - If found, extract unit string and remove brackets from latex

2. Set `unit_comment` field on Calculation when inline unit is found:
   - `unit_comment = extracted_unit` (e.g., "MWh")
   - Remove the `[unit]` from the calculation latex

3. Ensure backward compatibility:
   - HTML comment syntax `<!-- [unit] -->` still works (takes precedence if both present)
   - Inline syntax is an alternative, not replacement

Example transformation:
- Input: `$E == [MWh]$`
- Calculation.latex: `E ==` (brackets removed)
- Calculation.unit_comment: `MWh`

Do NOT modify `_apply_conversion()` - it already handles unit_comment.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source .venv/bin/activate
python -c "
from livemathtex.parser.lexer import Lexer
from livemathtex.parser.models import MathBlock

lexer = Lexer()
doc = lexer.parse('\$E == [kJ]\$')
for block in doc.children:
    if isinstance(block, MathBlock):
        calcs = lexer.extract_calculations(block)
        for c in calcs:
            print(f'latex: {c.latex}')
            print(f'unit_comment: {c.unit_comment}')
"
```
  </verify>
  <done>Lexer extracts `[unit]` from evaluations into unit_comment field</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for inline unit hint syntax</name>
  <files>tests/test_inline_unit_hints.py</files>
  <action>
Create test file for inline unit hint functionality:

1. Test parser extracts unit from `$E == [kJ]$`
2. Test parser extracts unit from `$x := expr == [m/s]$` (combined syntax)
3. Test full pipeline: `$E := 1000\ J$` then `$E == [kJ]$` produces `$E == 1\ \text{kJ}$`
4. Test compound units: `$vel == [km/h]$`
5. Test that HTML comment still works when used
6. Test that inline takes precedence when both are present (or document which does)
7. Test edge cases: empty brackets, invalid unit in brackets

Use `process_text()` for end-to-end tests, `Lexer` directly for parser tests.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source .venv/bin/activate
pytest tests/test_inline_unit_hints.py -v
```
  </verify>
  <done>Tests for inline unit hint syntax pass</done>
</task>

<task type="auto">
  <name>Task 3: Update documentation and close ISS-008</name>
  <files>docs/USAGE.md, .planning/ISSUES.md</files>
  <action>
1. Update docs/USAGE.md:
   - Add inline syntax to unit conversion section
   - Show both syntaxes side by side
   - Recommend inline for visibility: `$E == [kWh]$`
   - Note HTML comment still works: `$E ==$ <!-- [kWh] -->`

2. Move ISS-008 to Closed in ISSUES.md:
   - Mark resolved 2026-01-11
   - Solution: "Inline unit hint syntax implemented. Use `$E == [unit]$` for cleaner output unit specification."

3. Update README.md syntax table if unit hints are mentioned there.
  </action>
  <verify>
```bash
grep -A 5 "inline" /home/mark/Repositories/livemathtex/docs/USAGE.md
grep -A 3 "ISS-008" /home/mark/Repositories/livemathtex/.planning/ISSUES.md | head -10
```
  </verify>
  <done>Documentation updated, ISS-008 closed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_inline_unit_hints.py -v` passes all tests
- [ ] `pytest tests/ -x -q` - all tests still pass
- [ ] Inline syntax works: `$E == [kJ]$` produces converted output
- [ ] HTML comment syntax still works (backward compatibility)
- [ ] Documentation shows both syntaxes
- [ ] ISS-008 closed in ISSUES.md
</verification>

<success_criteria>

- `$E == [unit]$` syntax parses and converts correctly
- Both syntaxes documented and tested
- No regressions in existing functionality
- ISS-008 formally closed
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-unit-conversion/04-02-SUMMARY.md`

Then update:
- `.planning/STATE.md` - Phase 4 complete, milestone v1.1 ready
- `.planning/ROADMAP.md` - Mark Phase 4 as complete
</output>
