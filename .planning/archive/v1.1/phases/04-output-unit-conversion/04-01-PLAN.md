---
phase: 04-output-unit-conversion
plan: 01
type: execute
---

<objective>
Add tests and documentation for output unit conversion (ISS-007 verification).

Purpose: Verify and document the existing `<!-- [unit] -->` unit conversion functionality which is working but untested.
Output: Tests for unit conversion, updated documentation clarifying syntax.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (ISS-007, ISS-008)

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Current implementation
@src/livemathtex/engine/evaluator.py
@src/livemathtex/parser/lexer.py

**From ISSUES.md ISS-007:**
- Output unit conversion via `<!-- [unit] -->` syntax
- Current status: WORKING (verified via manual testing)
- Missing: Tests and documentation

**Prior phase summary (03-01):**
- Public API exported in __init__.py
- Patterns: TDD for bug fixes, atomic commits per task

**Key files:**
- `src/livemathtex/engine/evaluator.py` - `_apply_conversion()` handles unit conversion
- `src/livemathtex/parser/lexer.py` - Parses `unit_comment` from `<!-- [unit] -->` syntax

**Existing behavior (verified):**
- `$E := 1000000\ J$` followed by `$E ==$` <!-- [kJ] --> outputs `$E == 1000\ \text{kJ}$`
- Works for SI unit conversions, custom units, and compound units
- Requires subscripted variable names to avoid unit conflicts (established pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit conversion tests</name>
  <files>tests/test_unit_conversion.py</files>
  <action>
Create a new test file for output unit conversion:

1. Test basic conversions (J to kJ, kJ to MJ, m to km)
2. Test time conversions (s to h, h to s)
3. Test flow rate conversions (mÂ³/h to L/s)
4. Test energy conversions (J to kWh, W*s to kWh)
5. Test that `<!-- [unit] -->` syntax triggers conversion
6. Test that results are displayed in requested units (not SI base)
7. Test edge cases: same unit (no conversion needed), dimensionless values

Use `process_text()` API for testing. Follow existing test patterns (TDD style assertions).

Do NOT test inline `[unit]` syntax yet - that's ISS-008 in plan 04-02.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source .venv/bin/activate
pytest tests/test_unit_conversion.py -v
```
  </verify>
  <done>All unit conversion tests pass, covering basic and edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Update USAGE.md with unit conversion documentation</name>
  <files>docs/USAGE.md</files>
  <action>
Add a "Unit Conversion in Output" section to USAGE.md (after the existing units section):

1. Explain the `<!-- [unit] -->` syntax for output unit hints
2. Show examples: simple units, compound units, derived units
3. Explain when to use: display results in engineering-friendly units
4. Note: requires that target unit is dimensionally compatible
5. Reference to existing examples (engineering-units example)

Keep it concise (10-15 lines of examples). Focus on practical usage.
  </action>
  <verify>
```bash
grep -A 20 "Unit Conversion" /home/mark/Repositories/livemathtex/docs/USAGE.md
```
  </verify>
  <done>USAGE.md contains clear documentation for unit conversion syntax</done>
</task>

<task type="auto">
  <name>Task 3: Close ISS-007 in ISSUES.md</name>
  <files>.planning/ISSUES.md</files>
  <action>
Move ISS-007 from "Open Enhancements" to "Closed Enhancements" section:

1. Mark as resolved with date 2026-01-11
2. Add solution description: "Output unit conversion via `<!-- [unit] -->` syntax verified working. Tests added. Documentation updated."
3. Keep the original description for history

This task documents that ISS-007 was already implemented (possibly during prior work) and is now formally tested and documented.
  </action>
  <verify>
```bash
grep -A 3 "ISS-007" /home/mark/Repositories/livemathtex/.planning/ISSUES.md | head -10
```
  </verify>
  <done>ISS-007 moved to Closed section with resolution details</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_unit_conversion.py -v` passes all tests
- [ ] `docs/USAGE.md` contains unit conversion documentation
- [ ] `ISSUES.md` shows ISS-007 as closed
- [ ] Existing tests still pass: `pytest tests/ -x -q`
</verification>

<success_criteria>

- Unit conversion functionality has test coverage
- Documentation explains the syntax clearly
- ISS-007 formally closed
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-unit-conversion/04-01-SUMMARY.md`
</output>
