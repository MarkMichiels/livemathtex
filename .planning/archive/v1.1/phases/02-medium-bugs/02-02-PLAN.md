---
phase: 02-medium-bugs
plan: 02
type: execute
subsystem: engine
tags: [pint, units, latex, parsing]
---

<objective>
Fix ISS-005: LaTeX-wrapped units (`\text{m/s}^2`) should be parsed correctly by Pint.

Purpose: Enable users to write units with LaTeX formatting and have them converted properly.
Output: Extended `_unwrap_latex()` handles exponents, compound units, and LaTeX math operators.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fix/01-01-SUMMARY.md
@.planning/phases/02-medium-bugs/02-01-SUMMARY.md (if exists)

**Key files:**
@src/livemathtex/engine/pint_backend.py
@tests/test_pint_backend.py
@tests/test_unit_recognition.py

**From ISSUES.md ISS-005:**
- Problem: `\text{m/s}^2` breaks Pint parsing due to LaTeX escapes
- Current: `_unwrap_latex()` only strips `\text{...}` wrapper, doesn't handle `^2`
- Solution: Extend to convert `^2` â†’ `**2`, `\cdot` â†’ `*`, etc.

**Existing pattern:**
- `_unwrap_latex()` at line 106 uses `_LATEX_WRAPPER_PATTERN` to extract from `\text{...}`
- Already handles `\text{kg}`, `\mathrm{kW}` simple cases
- Needs extension for compound cases like `\text{m/s}^2`

**Constraining decisions:**
- Phase 1: TDD approach proven effective
- Pint is single source of truth for units
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for LaTeX unit cleaning</name>
  <files>tests/test_pint_backend.py</files>
  <action>
Add new test class to `tests/test_pint_backend.py` for ISS-005:

```python
class TestCleanLatexUnit:
    """Tests for ISS-005: LaTeX-wrapped units with exponents."""

    def test_text_wrapper_with_exponent(self):
        """\\text{m/s}^2 should become m/s**2."""
        result = clean_latex_unit("\\text{m/s}^2")
        assert result == "m/s**2"

    def test_mathrm_wrapper(self):
        """\\mathrm{kg} should become kg."""
        result = clean_latex_unit("\\mathrm{kg}")
        assert result == "kg"

    def test_bare_exponent(self):
        """m^3 should become m**3."""
        result = clean_latex_unit("m^3")
        assert result == "m**3"

    def test_braced_exponent(self):
        """m^{-2} should become m**-2."""
        result = clean_latex_unit("m^{-2}")
        assert result == "m**-2"

    def test_cdot_multiplication(self):
        """kg \\cdot m/s^2 should become kg * m/s**2."""
        result = clean_latex_unit("kg \\cdot m/s^2")
        assert result == "kg * m/s**2"

    def test_multiple_text_wrappers(self):
        """\\text{kW} \\cdot \\text{h} should become kW * h."""
        result = clean_latex_unit("\\text{kW} \\cdot \\text{h}")
        assert result == "kW * h"

    def test_frac_notation(self):
        """\\frac{m}{s^2} should become m/s**2."""
        result = clean_latex_unit("\\frac{m}{s^2}")
        assert result == "m/s**2"
```

Import `clean_latex_unit` from pint_backend (will fail - function doesn't exist yet).
Run tests - they MUST fail.
  </action>
  <verify>pytest tests/test_pint_backend.py::TestCleanLatexUnit -v shows failing tests</verify>
  <done>Test class created with 7 failing tests covering LaTeX unit patterns</done>
</task>

<task type="auto">
  <name>Task 2: Implement clean_latex_unit function</name>
  <files>src/livemathtex/engine/pint_backend.py</files>
  <action>
Add new function `clean_latex_unit()` after `_unwrap_latex()` (around line 123):

```python
def clean_latex_unit(latex_unit: str) -> str:
    """
    Convert LaTeX unit notation to Pint-compatible string.

    Handles:
    - \\text{...} and \\mathrm{...} wrappers
    - LaTeX exponents: ^2 â†’ **2, ^{-3} â†’ **-3
    - LaTeX multiplication: \\cdot â†’ *
    - LaTeX fractions: \\frac{a}{b} â†’ a/b

    Args:
        latex_unit: The LaTeX-formatted unit string.

    Returns:
        Pint-compatible unit string.

    Examples:
        >>> clean_latex_unit("\\\\text{m/s}^2")
        'm/s**2'
        >>> clean_latex_unit("kg \\\\cdot m/s^2")
        'kg * m/s**2'
    """
    if latex_unit is None:
        return ""

    unit = latex_unit.strip()

    # Remove \\text{...} and \\mathrm{...} wrappers (keep content)
    unit = re.sub(r'\\text\{([^}]+)\}', r'\1', unit)
    unit = re.sub(r'\\mathrm\{([^}]+)\}', r'\1', unit)
    unit = re.sub(r'\\mathit\{([^}]+)\}', r'\1', unit)
    unit = re.sub(r'\\textit\{([^}]+)\}', r'\1', unit)
    unit = re.sub(r'\\mathbf\{([^}]+)\}', r'\1', unit)

    # Convert \\frac{num}{denom} to num/denom
    unit = re.sub(r'\\frac\{([^}]+)\}\{([^}]+)\}', r'\1/\2', unit)

    # Convert LaTeX exponents to Python: ^2 â†’ **2, ^{-3} â†’ **-3
    unit = re.sub(r'\^\{([^}]+)\}', r'**\1', unit)  # braced first
    unit = re.sub(r'\^(-?\d+)', r'**\1', unit)       # then bare

    # Convert LaTeX multiplication to Python
    unit = unit.replace('\\cdot', '*')
    unit = unit.replace('Â·', '*')  # Unicode middle dot

    # Remove any remaining backslashes (LaTeX escapes)
    unit = unit.replace('\\', '')

    # Clean up whitespace around operators
    unit = re.sub(r'\s*\*\s*', ' * ', unit)
    unit = re.sub(r'\s*/\s*', '/', unit)
    unit = unit.strip()

    return unit
```

Export the function by adding it to the module's public API (if `__all__` exists, add it there).
  </action>
  <verify>pytest tests/test_pint_backend.py::TestCleanLatexUnit -v shows all tests passing</verify>
  <done>clean_latex_unit() implemented and all unit cleaning tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Integrate clean_latex_unit into unit parsing pipeline</name>
  <files>src/livemathtex/engine/pint_backend.py, src/livemathtex/engine/evaluator.py</files>
  <action>
Integrate `clean_latex_unit()` into the unit parsing flow:

1. In `pint_backend.py`, modify functions that receive raw LaTeX units:
   - `is_unit_token()`: Call `clean_latex_unit()` instead of just `_unwrap_latex()`
   - `get_unit()`: Same change
   - `parse_unit_string()`: Same change
   - Any other functions that parse unit strings

2. In `evaluator.py`, if there are places where unit strings are extracted from LaTeX
   and passed to Pint, ensure they go through `clean_latex_unit()` first.

Key principle: LaTeX â†’ clean_latex_unit() â†’ Pint

Test with a document containing `$a_1 := 9.81\ \text{m/s}^2$` to verify end-to-end.
  </action>
  <verify>Create test document with LaTeX units, process it, verify units are parsed correctly</verify>
  <done>LaTeX units like `\text{m/s}^2` are correctly converted to Pint-compatible format</done>
</task>

<task type="auto">
  <name>Task 4: Run full test suite and update ISSUES</name>
  <files>.planning/ISSUES.md</files>
  <action>
1. Run full test suite: `pytest tests/ -v`
2. Ensure all tests still pass (no regressions)
3. Update .planning/ISSUES.md:
   - Change ISS-005 status from "ðŸŸ¡ OPEN" to "âœ… RESOLVED"
   - Add "Resolved: 2026-01-11" date
   - Add brief "Solution implemented" section describing the fix
4. Update `examples/README.md` if needed to document LaTeX unit support
  </action>
  <verify>pytest tests/ -v shows all tests passing</verify>
  <done>All tests pass, ISSUES.md updated with ISS-005 resolution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_pint_backend.py::TestCleanLatexUnit -v` - all LaTeX unit tests pass
- [ ] `pytest tests/ -v` - full suite passes (no regressions)
- [ ] ISS-005 marked resolved in ISSUES.md
- [ ] End-to-end test: `$a := 9.81\ \text{m/s}^2$` processes correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- LaTeX-wrapped units like `\text{m/s}^2` are correctly parsed
- Existing unit parsing behavior preserved
- Phase 2 complete (both ISS-004 and ISS-005 resolved)
</success_criteria>

<output>
After completion, create `.planning/phases/02-medium-bugs/02-02-SUMMARY.md` following summary.md template with:
- RED: What tests were written, why they failed
- GREEN: What implementation made them pass
- Files created/modified
- Decisions made
- Phase 2 complete, ready for Phase 3
</output>
