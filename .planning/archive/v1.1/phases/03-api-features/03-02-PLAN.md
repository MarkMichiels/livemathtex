---
phase: 03-api-features
plan: 02
type: execute
---

<objective>
Add `livemathtex clear` command to reset document calculations.

Purpose: Provide a way to clean a processed document back to its original state, removing computed values and error messages.
Output: New `clear` CLI subcommand that strips computed results while preserving definitions and structure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md (ISS-011)

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Current implementation
@src/livemathtex/cli.py
@src/livemathtex/core.py

**From ISSUES.md ISS-011:**
- After `livemathtex process`, document contains computed values and error messages
- Need command to clean it back to original state
- Should: remove computed values after `==`, remove error markup, preserve definitions and structure
- Files: cli.py (add subcommand), core.py (add `clear_text()`)

**CLI patterns (from cli.py):**
- Uses Click for CLI
- Commands: `process`, `inspect`
- Common pattern: `@main.command()` decorator
- File argument: `click.argument('input_file', type=click.Path(exists=True))`
- Output option: `@click.option('-o', '--output', ...)`

**Document structure:**
- Definitions: `$x := 5$` (keep as-is)
- Evaluations: `$x == 42$` → clear to `$x ==$`
- Combined: `$y := x^2 == 1764$` → clear to `$y := x^2 ==$`
- Errors: `\color{red}...` markup → remove entirely
- Unit hints: `<!-- [N] -->` → preserve
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clear_text() function to core.py</name>
  <files>src/livemathtex/core.py</files>
  <action>
Add a `clear_text(content: str) -> str` function that:
1. Uses regex to find evaluation results: pattern `== [^$]+\$` (everything after `==` up to closing `$`)
2. Replaces with just `==$` (preserving the closing `$`)
3. Removes error markup: `\color{red}{...}` and `\text{(Error: ...)}` patterns
4. Preserves everything else: definitions (`:=`), unit hints (`<!-- [...] -->`), structure

Key patterns to clear:
- `== 42$` → `==$`
- `== 49.05\ \text{N}$` → `==$`
- `\color{red}{Error: ...}` → remove
- `\text{(Error: ...)}` → remove

Do NOT modify:
- `:= 5$` (definitions)
- `<!-- [N] -->` (unit hints)
- `===` (unit definitions)
- `=>` results (symbolic - these are different)

Use `re.sub()` with careful patterns. Test with edge cases.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source venv/bin/activate
python -c "
from livemathtex.core import clear_text
# Test basic clearing
input_text = r'\$x == 42\$'
result = clear_text(input_text)
print(f'Input: {input_text}')
print(f'Output: {result}')
assert '42' not in result, 'Value should be cleared'
print('Basic clear: OK')
"
```
  </verify>
  <done>`clear_text()` function removes computed values and error markup</done>
</task>

<task type="auto">
  <name>Task 2: Add clear subcommand to cli.py</name>
  <files>src/livemathtex/cli.py</files>
  <action>
Add a `clear` subcommand following the existing pattern:

```python
@main.command()
@click.argument('input_file', type=click.Path(exists=True))
@click.option('-o', '--output', type=click.Path(), help="Output file path (default: overwrite input)")
def clear(input_file, output):
    """Clear computed values from a processed document.

    Removes evaluation results (== values) and error markup while
    preserving definitions, structure, and unit hints.

    Examples:
        livemathtex clear processed.md
        livemathtex clear processed.md -o clean.md
    """
```

Implementation:
1. Read input file
2. Call `clear_text()` from core
3. Write to output (default: overwrite input, respect -o flag)
4. Show summary: "Cleared N evaluations from FILE"

Import `clear_text` from `.core` at the top of cli.py.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source venv/bin/activate
livemathtex clear --help
```
  </verify>
  <done>`livemathtex clear` command available and shows help</done>
</task>

<task type="auto">
  <name>Task 3: Test clear command with example</name>
  <files>examples/error-handling/output.md</files>
  <action>
Test the clear command on a real processed file:

1. Copy examples/error-handling/output.md to a temp file
2. Run `livemathtex clear` on it
3. Verify results are cleared but definitions preserved
4. Verify the cleared file can be re-processed

This is a functional test, not modifying the example files permanently.

Document the test in a comment or print statements.
  </action>
  <verify>
```bash
cd /home/mark/Repositories/livemathtex
source venv/bin/activate
# Create temp copy
cp examples/error-handling/output.md /tmp/test_clear.md
# Clear it
livemathtex clear /tmp/test_clear.md
# Check results are gone
if grep -q "== [0-9]" /tmp/test_clear.md; then
  echo "FAIL: Values still present"
  exit 1
else
  echo "OK: Values cleared"
fi
# Re-process to verify it still works
livemathtex process /tmp/test_clear.md -o /tmp/test_clear_out.md --verbose
echo "Re-process successful"
```
  </verify>
  <done>Clear command works on real documents and cleared docs can be re-processed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `livemathtex clear --help` shows usage
- [ ] `clear_text()` removes `== value` patterns
- [ ] `clear_text()` removes error markup
- [ ] `clear_text()` preserves definitions and unit hints
- [ ] Cleared documents can be re-processed
- [ ] Existing tests still pass: `pytest tests/ -x -q`
</verification>

<success_criteria>

- `livemathtex clear` command available
- Clears evaluation results while preserving definitions
- Clears error markup
- Preserves unit hints (`<!-- [N] -->`)
- Default behavior overwrites input (like common CLI tools)
- `-o` flag allows specifying different output
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-features/03-02-SUMMARY.md`
</output>
